
```{r message=FALSE, warning=FALSE, include=FALSE}
# a description of how to view and read the data from the data package
baseball_package <- read_package(
  find_root_file("data", "processed", "datapackage_analysis",
    "datapackage.json", 
    criterion = has_file("baseball_thesis.Rproj")))
#overview of all resources (=datasets) in the data package
resources(baseball_package)
#Extract a single resource and assign it to a R object
wp3_ua_sirm_data <- read_resource(package = baseball_package,
                               resource_name = "wp3_ua_sirm_data")
#inspect the description
get_schema(package = baseball_package,
           resource_name = "wp3_ua_sirm_data")$fields %>%
  bind_rows() %>%
  kable(booktabs = TRUE) %>%
  kableExtra::kable_styling()

#General data about the parents
gen_data <- read_resource(package = baseball_package,
              resource_name = "wp5_parents_general_questions_data")
gen_key <- read_resource(package = baseball_package,
              resource_name = "wp5_parents_general_questions_key")
#socio-economic status
ses_data <- read_resource(package = baseball_package,
              resource_name = "wp5_parents_ses_questions_data")
ses_key <- read_resource(package = baseball_package,
              resource_name = "wp5_parents_ses_questions_key")
```

# Results

## Demographics

## Scale questions

### Attitude towards outdoor play (ATOP) in kids

```{r read_atop, message=FALSE, warning=FALSE, include=FALSE}
# a description of how to view and read the data from the data package
atop_data <- read_resource(package = baseball_package,
              resource_name = "wp5_atop_data")
atop_key <- read_resource(package = baseball_package,
              resource_name = "wp5_atop_questions")
#inspect the description
get_schema(package = baseball_package,
           resource_name = "wp5_atop_data")$fields %>%
  bind_rows() %>%
  kable(booktabs = TRUE) %>%
  kableExtra::kable_styling()
```

Among the `r nrow(children)` children that were selected for the study, `r length(unique(atop_data$child_id))` children filled in the ATOP questions. Table \@ref(tab:atopkids-descriptives) shows the descriptive statistics for ATOP scale items in all children.

Figure \@ref(fig:atopkids-descriptives2) shows the descriptive statistics for Dutch-speaking and French-speaking children separately (there are children that are in a bilingual school; they are included in both). The results are similar though French-speaking children are markedly less afraid of getting lost in nature.

```{r atopkids-descriptives, message=FALSE, warning=FALSE, include=TRUE, echo = FALSE}
nb <- length(unique(atop_data$child_id))
tbl <- atop_data %>%
  group_by(question_short, interpretation) %>%
  summarize(n = n()) %>%
  ungroup() %>%
  mutate(summ = sprintf("%.0f (%.0f%%)", n, n/nb*100)) %>%
  left_join(atop_key %>% dplyr::select(question_short, question_text_english)) %>%
  dplyr::select(-n, -question_short) %>%
  pivot_wider(names_from = interpretation,
              values_from = summ)  %>% 
  mutate_at(2:6, ~replace_na(.,"")) %>%
  dplyr::select(question_text_english, Disagree, `Slightly disagree`,
                `Moderately agree`, Agree, `No response`)
tbl[order(match(tbl$question_text_english, atop_key$question_text_english)),] %>%
  kable(booktabs = TRUE,
        caption = "Descriptive statistics for Attitude Towards Outdoor Play
        scale items in children.",
        col.names = c("Item", "Disagree", "Slightly disagree",
                     "Moderately agree", "Agree", "No response")) %>%
  kableExtra::kable_styling(font_size = 9) %>%
  kableExtra::column_spec(1, width = "2in") %>%
  kableExtra::column_spec(2:6, width = "0.6in")
```

```{r atopkids-descriptives2, message=FALSE, warning=FALSE, include=TRUE, echo = FALSE, fig.cap = "Descriptive statistics for Dutch-speaking (left) and French-speaking (right) children for the ATOP scale items.", fig.width = 6.5, fig.height = 6.5}
likert_data_atop <- atop_data %>%
  as.data.frame() %>%
  left_join(children) %>%
  dplyr::filter(str_detect(community, "Dutch speaking")) %>%
  mutate(interpretation = factor(as.factor(interpretation),
                                 levels = c("Disagree", "Slightly disagree",
                                            "No response",
                                            "Moderately agree", "Agree"))) %>%
  dplyr::select(question_short, interpretation) %>%
  pivot_wider(names_from = question_short, values_from = interpretation,
              values_fn = list)
likert_data_atop2 <- as.data.frame(do.call(cbind,
                                          sapply(1:ncol(likert_data_atop),
                                                 FUN = function(x) {
                                                   likert_data_atop[[x]]
                                          })))
colnames(likert_data_atop2) <- names(likert_data_atop)
likert_data_atop <- likert_data_atop2 %>%
  mutate(across(think_clearly:getting_hurt, function(x) factor(as.factor(x),
                                      levels = 1:5,                      
                                      labels = c("Disagree",
                                                 "Slightly disagree",
                                                 "No response",
                                                 "Moderately agree",
                                                 "Agree"))))
names(likert_data_atop) <- atop_key$question_text_english
p_nl <- gglikert(likert_data_atop, sort = "none", y_label_wrap = 20,
                 labels_size = 2)
 

likert_data_atop <- atop_data %>%
  as.data.frame() %>%
  left_join(children) %>%
  dplyr::filter(str_detect(community, "French speaking")) %>%
  mutate(interpretation = factor(as.factor(interpretation),
                                 levels = c("Disagree", "Slightly disagree",
                                            "No response",
                                            "Moderately agree", "Agree"))) %>%
  dplyr::select(question_short, interpretation) %>%
  pivot_wider(names_from = question_short, values_from = interpretation,
              values_fn = list)
likert_data_atop2 <- as.data.frame(do.call(cbind,
                                          sapply(1:ncol(likert_data_atop),
                                                 FUN = function(x) {
                                                   likert_data_atop[[x]]
                                          })))
colnames(likert_data_atop2) <- names(likert_data_atop)
likert_data_atop <- likert_data_atop2 %>%
  mutate(across(think_clearly:getting_hurt, function(x) factor(as.factor(x),
                                      levels = 1:5,                      
                                      labels = c("Disagree",
                                                 "Slightly disagree",
                                                 "No response",
                                                 "Moderately agree",
                                                 "Agree"))))
names(likert_data_atop) <- atop_key$question_text_english

p_fr <- gglikert(likert_data_atop, sort = "none", y_label_wrap = 20,
                 labels_size = 2) +
  theme(axis.text.y = element_blank())
p_nl + p_fr + plot_layout(guides = "collect") &
  theme(legend.position = "bottom",
        text = element_text(size = 9))
```

@beyer2015development prescribes that the ATOP scale for children had two sub-scales: ATOP-benefits and ATOP-fears (see Table \@ref(tab:atop-translation-kids) in the appendix). We first execute an exploratory factor analysis and we hypothesize that the `r length(unique(atop_data$question_code))` test scores can be explained by these two common factors. We will use oblique rotation to allow for correlation between the factors.
Figure \@ref(fig:atopkids-scree) shows that two (according to optimal coordinates method) or three (according to the acceleration factor method) factors should fit best.

```{r atopkids-cfa, message=FALSE, warning=FALSE, include=FALSE, echo = FALSE}
#there are some children who filled it in more than once -> we take the average score for them
atop_data %>% group_by(child_id, question_short) %>%
  summarise(n = dplyr::n(), .groups = "drop") %>%
  dplyr::filter(n > 1L)
data_cfa_atop <- atop_data %>%
  dplyr::select(child_id, question_short, response_values) %>%
  mutate(response_values = ifelse(response_values == -9,
                                  NA,
                                  response_values)) %>%
  group_by(child_id, question_short) %>%
  summarize(response_values = mean(response_values, na.rm = TRUE)) %>%
  ungroup() %>%
  pivot_wider(id_cols = child_id, names_from = question_short,
              values_from = response_values) %>%
  dplyr::select(child_id, atop_key$question_short)

#first, we need to standardize our variables
data_cfa_atop_unscaled <- data_cfa_atop
data_cfa_atop[,-1] <- scale(data_cfa_atop[,-1], center = TRUE, scale = FALSE)

data_cfa_atop <- data_cfa_atop[complete.cases(data_cfa_atop),]
covmat <- cov(data_cfa_atop[,-1])
cormat <- cor(data_cfa_atop[,-1])

#exploratory factor analysis on correlation matrix with 3 factors and oblique rotation
efa_obl2 <- fa(cormat, covar = FALSE, 2, rotate = "oblimin", fm = "ml",
               n.obs = nrow(data_cfa_atop))
#list matrix of structure loadings
print(efa_obl2$Structure, cutoff = 0, digits = 3)
#list matrix of residual correlations
round(efa_obl2$residual, 3)
#compute factor scores after oblique rotation
scores_efaobl2 <- factor.scores(data_cfa_atop[,-1], efa_obl2,
                                method = "tenberge")
tables_atop <- fa_table(efa_obl2,
                        title = "Factor analysis results with oblique rotation
                        and two factors.",
                        varlabels = str_wrap(atop_key$question_text_english, 15),
                        fnames = c("ATOP_benefits", "ATOP_fears"))
# apply PCA
pca <- prcomp(data_cfa_atop[,-1])
scree1 <- screeplot(pca, type = "lines")#3 factors is likely better
ev <- eigen(cormat) # get eigenvalues
ap <- parallel(subject = nrow(data_cfa_atop), var = ncol(data_cfa_atop)-1,
  rep = 100, cent = .05)
nS <- nScree(x = ev$values, aparallel = ap$eigen$qevpea)
pdf(find_root_file(
    "data", "figures",
    "scree_atop.pdf", 
    criterion = has_file("baseball_thesis.Rproj")), width = 6.5, height = 4)
plotnScree(nS)
dev.off()

resid <- cormat -
   (crossprod(t(efa_obl2$loadings)) + diag(efa_obl2$uniquenesses))
n <- sum(ifelse(abs(resid) > 0.05, 1, 0)) / 2
non_redundant_factors <- n / (11*12/2)

#cronbach alpha
alpha_ATOP_benefits <- alpha(data_cfa_atop_unscaled %>% dplyr::select(2:8))
alpha_ATOP_benefits_nl <- alpha(data_cfa_atop_unscaled %>%
                               left_join(children %>%
                                           dplyr::select(child_id,
                                                         community)) %>%
                               dplyr::filter(str_detect(community, "Dutch")) %>%
                               dplyr::select(2:8))
alpha_ATOP_benefits_fr <- alpha(data_cfa_atop_unscaled %>%
                               left_join(children %>%
                                           dplyr::select(child_id,
                                                         community)) %>%
                               dplyr::filter(str_detect(community, "French")) %>%
                               dplyr::select(2:8))
alpha_ATOP_fears <- alpha(data_cfa_atop_unscaled %>% dplyr::select(9:12))
alpha_ATOP_fears_nl <- alpha(data_cfa_atop_unscaled %>%
                            left_join(children %>%
                                        dplyr::select(child_id,
                                                      community)) %>%
                            dplyr::filter(str_detect(community, "Dutch")) %>%
                            dplyr::select(9:12))
alpha_ATOP_fears_fr <- alpha(data_cfa_atop_unscaled %>%
                            left_join(children %>%
                                        dplyr::select(child_id,
                                                      community)) %>%
                            dplyr::filter(str_detect(community, "French")) %>%
                            dplyr::select(9:12))

```


In total, `r nrow(data_cfa_atop)` out of the `r nrow(children)` children filled in all of the ATOP questions and can therefor be analyzed further.

```{r atopkids-scree, warning=FALSE, message=FALSE, fig.cap="Analysis of the number of component or factors to retain in an exploratory principal component or factor analysis.", echo=FALSE, include=TRUE}
knitr::include_graphics(find_root_file(
    "data", "figures",
    "scree_atop.pdf", 
    criterion = has_file("baseball_thesis.Rproj")))
```

Exploring the factor analysis with two factors, we can see that the two original factors ATOP_benefits and ATOP_fears re-emerge as shown in the Tables \@ref(tab:atop-2fact-1) and \@ref(tab:atop-2fact-2). Figure \@ref(fig:atop-kids-loadings) shows the factor loadings graphically.

Both factors together explain `r 100*round(efa_obl2$Vaccounted[3,2],3)`% of the total variance and uniqueness is pretty high for many items meaning a large part of the variance is not explained. Indeed, `r round(100*non_redundant_factors,2)` percent of the correlations are non-redundant (i.e. the absolute value of the residual > 0.05).

```{r atop-2fact-1, warning=FALSE, message=FALSE, echo=FALSE, include=TRUE}
tables_atop$ind_table
```

```{r atop-2fact-2, warning=FALSE, message=FALSE, echo=FALSE, include=TRUE}
tables_atop$f_table
```

```{r atop-kids-loadings, warning=FALSE, message=FALSE, echo=FALSE, include=TRUE, fig.cap = "Graphical representation of the factor loadings.", fig.width = 4.5, fig.height = 3}
data.frame(ATOP_benefits = efa_obl2$loadings[, 1],
           ATOP_fears = efa_obl2$loadings[, 2]) %>%
  ggplot(aes(x = ATOP_benefits, y = ATOP_fears)) +
  geom_point() +
  geom_vline(aes(xintercept = 0)) +
  geom_hline(aes(yintercept = 0)) +
  xlim(-0.5, 1) + ylim(-0.5, 1) +
  ggrepel::geom_text_repel(aes(label = names(efa_obl2$loadings[, 1]))) + 
  theme_bw()
```

We further analyse this two-factor model by calculating Chronbach alpha for the ATOP_benefits and ATOP_fears scale items separately.
The raw alpha value for ATOP_benefits is `r round(unlist(unname(alpha_ATOP_benefits$total["raw_alpha"])), 2)` (`r round(unlist(unname(alpha_ATOP_benefits_nl$total["raw_alpha"])), 2)` in the Dutch and `r round(unlist(unname(alpha_ATOP_benefits_fr$total["raw_alpha"])), 2) ` in the French questionnaire separately) and `r round(unlist(unname(alpha_ATOP_fears$total["raw_alpha"])), 2)` for ATOP_fears (`r round(unlist(unname(alpha_ATOP_fears_nl$total["raw_alpha"])), 2)` in the Dutch and `r round(unlist(unname(alpha_ATOP_fears_fr$total["raw_alpha"])), 2)` in the French questionnaire separately) respectively which is slightly worse than the original scale items (0.79 for both subscales in @beyer2015development).

While the ATOP_benefits scale is just higher then the threshold for good reliability (0.7), the ATOP_fears scale is not.
This might be due to the fact that one question from the original ATOP_fears scale was left out (about people with drugs in nature).

The first column in Table \@ref(tab:atop-kids-alpha) shows the overall $\alpha$ when each statement is dropped from the scale.
It can be seen that the statement "I like to make up my own games when I am outdoors in nature." might have very little value since $\alpha$ barely decreases if it is dropped. 
The items with the highest item-scale correlation in both the ATOP_benefits and ATOP_fears scale also lower $\alpha$ the most if they are dropped.
Note that the second column shows correlations when the item itself is removed from the scale.
The last two columns in  Table \@ref(tab:atop-kids-alpha) show the mean and standard deviation for the statement's answers.


```{r atop-kids-alpha, warning=FALSE, message=FALSE, echo=FALSE, include=TRUE}
alpha_ATOP_benefits$alpha.drop["raw_alpha"] %>%
  cbind(alpha_ATOP_benefits$item.stats[c("r.drop", "mean", "sd")]) %>%
  rbind(alpha_ATOP_fears$alpha.drop["raw_alpha"] %>%
          cbind(alpha_ATOP_fears$item.stats[c("r.drop",
                                              "mean", "sd")])) %>%
  mutate(question_short = row.names(.)) %>%
  left_join(atop_key %>% dplyr::select(question_short, question_text_english),
            by = ) %>%
  dplyr::select(question_text_english, raw_alpha, r.drop, mean, sd) %>%
  kable(booktabs = TRUE,
        escape = FALSE,
        caption = "Reliability if an item is dropped and item statistics.",
        digits = 3,
        col.names = c("item", "raw $\\alpha$", "item-scale corr.", "mean", "std. dev.")) %>%
  kableExtra::group_rows(start_row = 1,
                         end_row = nrow(alpha_ATOP_benefits$alpha.drop),
                         group_label = "ATOP_benefits") %>%
  kableExtra::group_rows(start_row = 1 + nrow(alpha_ATOP_benefits$alpha.drop),
                         end_row = nrow(alpha_ATOP_benefits$alpha.drop) +
                           nrow(alpha_ATOP_fears$alpha.drop),
                         group_label = "ATOP_fears") %>%
  kableExtra::kable_styling(font_size = 9) %>%
  kableExtra::column_spec(1, width = "3in") %>%
  kableExtra::column_spec(3, width = "0.7in")
```


\clearpage

### Nature connectedness in kids

```{r read_nc, message=FALSE, warning=FALSE, include=FALSE}
# a description of how to view and read the data from the data package
nc_data <- read_resource(package = baseball_package,
              resource_name = "wp5_nc_data")
nc_key <- read_resource(package = baseball_package,
              resource_name = "wp5_nc_key")
#inspect the description
get_schema(package = baseball_package,
           resource_name = "wp5_nc_data")$fields %>%
  bind_rows() %>%
  kable(booktabs = TRUE) %>%
  kableExtra::kable_styling()
```

Among the `r nrow(children)` children that were selected for the study, `r length(unique(nc_data$child_id))` children filled in the Nature connectedness questions. Table \@ref(tab:nc-descriptives) shows the descriptive statistics for NC scale items in all children. While the original article suggested to use a 7-point likert scale, a 5-point likert scale was used for brevity. 

In preliminary tests of the survey with a few children, some questions were not clear enough. They were then clarified with some more detail between brackets (see Table \@ref(tab:nc-translation) in the Appendix)

Figure \@ref(fig:nc-descriptives2) shows the descriptive statistics for Dutch-speaking and French-speaking children separately (there are children that are in a bilingual school; they are included in both). The results are quite similar though Dutch-speaking children were more outspoken (they tend to choose the "I don't know" option less). Dutch children also agree more with the statement that nature is very beautiful and less with the statement on feeling part of nature.

```{r nc-descriptives, message=FALSE, warning=FALSE, include=TRUE, echo = FALSE}
nb <- length(unique(nc_data$child_id))
tbl <- nc_data %>%
  group_by(question_short, interpretation) %>%
  summarize(n = n()) %>%
  ungroup() %>%
  mutate(summ = sprintf("%.0f (%.0f%%)", n, n/nb*100)) %>%
  left_join(nc_key %>% dplyr::select(question_short, question_text_english)) %>%
  dplyr::select(-n, -question_short) %>%
  pivot_wider(names_from = interpretation,
              values_from = summ)  %>% 
  mutate_at(2:6, ~replace_na(.,"")) %>%
  dplyr::select(question_text_english, Disagree, `Slightly disagree`,
                `Don't know`, `Moderately agree`, Agree, `No response`)
tbl[order(match(tbl$question_text_english, nc_key$question_text_english)),] %>%
  kable(booktabs = TRUE,
        caption = "Descriptive statistics for Nature Connectedness
        scale items in children.",
        col.names = c("Item", "Disagree", "Slightly disagree", "Don't know",
                     "Moderately agree", "Agree", "No response")) %>%
  kableExtra::kable_styling(font_size = 9) %>%
  kableExtra::column_spec(1, width = "2in") %>%
  kableExtra::column_spec(2:6, width = "0.6in")
```

```{r nc-descriptives2, message=FALSE, warning=FALSE, include=TRUE, echo = FALSE, fig.cap = "Descriptive statistics for Dutch-speaking (left) and French-speaking (right) children for the Nature connectedness scale items. Non-responses are not shown but taken into account when calculating the percentages.", fig.width = 6.5, fig.height = 6.5}
likert_data_nc <- nc_data %>%
  as.data.frame() %>%
  left_join(children) %>%
  dplyr::filter(str_detect(community, "Dutch speaking")) %>%
  mutate(interpretation = factor(as.factor(interpretation),
                                 levels = c("Disagree", "Slightly disagree",
                                            "No response", "Don't know",
                                            "Moderately agree", "Agree"))) %>%
  dplyr::select(question_short, interpretation) %>%
  pivot_wider(names_from = question_short, values_from = interpretation,
              values_fn = list)
likert_data_nc2 <- as.data.frame(do.call(cbind,
                                          sapply(1:ncol(likert_data_nc),
                                                 FUN = function(x) {
                                                   likert_data_nc[[x]]
                                          })))
colnames(likert_data_nc2) <- names(likert_data_nc)
likert_data_nc <- likert_data_nc2 %>%
  mutate(across(beauty:part_of, function(x) factor(as.factor(x),
                                      levels = 1:6,                      
                                      labels = c("Disagree",
                                                 "Slightly disagree",
                                                 "No response", "Don't know",
                                                 "Moderately agree", "Agree"))))
names(likert_data_nc) <- nc_key$question_text_english
p_nl <- gglikert(likert_data_nc,
                 exclude_fill_values = "No response",
                 sort = "none", y_label_wrap = 20,
                 labels_size = 2)
 

likert_data_nc <- nc_data %>%
  as.data.frame() %>%
  left_join(children) %>%
  dplyr::filter(str_detect(community, "French speaking")) %>%
  mutate(interpretation = factor(as.factor(interpretation),
                                 levels = c("Disagree", "Slightly disagree",
                                            "No response", "Don't know",
                                            "Moderately agree", "Agree"))) %>%
  dplyr::select(question_short, interpretation) %>%
  pivot_wider(names_from = question_short, values_from = interpretation,
              values_fn = list)
likert_data_nc2 <- as.data.frame(do.call(cbind,
                                          sapply(1:ncol(likert_data_nc),
                                                 FUN = function(x) {
                                                   likert_data_nc[[x]]
                                          })))
colnames(likert_data_nc2) <- names(likert_data_nc)
likert_data_nc <- likert_data_nc2 %>%
  mutate(across(beauty:part_of, function(x) factor(as.factor(x),
                                      levels = 1:6,                      
                                      labels = c("Disagree",
                                                 "Slightly disagree",
                                                 "No response", "Don't know",
                                                 "Moderately agree", "Agree"))))
names(likert_data_nc) <- nc_key$question_text_english

p_fr <- gglikert(likert_data_nc, sort = "none",
                 exclude_fill_values = "No response", y_label_wrap = 20,
                 labels_size = 2) +
  theme(axis.text.y = element_blank())
p_nl + p_fr + plot_layout(guides = "collect") &
  theme(legend.position = "bottom",
        text = element_text(size = 9))
```

<!-- @beyer2015development prescribes that the ATOP scale for children had two sub-scales: ATOP-benefits and ATOP-fears (see Table \@ref(tab:atop-translation-kids) in the appendix). We first execute an exploratory factor analysis and we hypothesize that the `r length(unique(atop_data$question_code))` test scores can be explained by these two common factors. We will use oblique rotation to allow for correlation between the factors. -->
<!-- Figure \@ref(fig:atopkids-scree) shows that two (according to optimal coordinates method) or three (according to the acceleration factor method) factors should fit best. -->

```{r nc-cfa, message=FALSE, warning=FALSE, include=FALSE, echo = FALSE}
#there are some children who filled it in more than once -> we take the average score for them
nc_data %>% group_by(child_id, question_short) %>%
  summarise(n = dplyr::n(), .groups = "drop") %>%
  dplyr::filter(n > 1L)
data_cfa_nc <- nc_data %>%
  dplyr::select(child_id, question_short, response_values) %>%
  mutate(response_values = ifelse(response_values == -9,
                                  NA,
                                  response_values)) %>%
  group_by(child_id, question_short) %>%
  summarize(response_values = mean(response_values, na.rm = TRUE)) %>%
  ungroup() %>%
  pivot_wider(id_cols = child_id, names_from = question_short,
              values_from = response_values) %>%
  dplyr::select(child_id, nc_key$question_short)

#first, we need to standardize our variables
data_cfa_nc_unscaled <- data_cfa_nc
data_cfa_nc[,-1] <- scale(data_cfa_nc[,-1], center = TRUE, scale = FALSE)

data_cfa_nc <- data_cfa_nc[complete.cases(data_cfa_nc),]
covmat <- cov(data_cfa_nc[,-1])
cormat <- cor(data_cfa_nc[,-1])

#exploratory factor analysis on correlation matrix with 3 factors and oblique rotation
efa_obl2 <- fa(cormat, covar = FALSE, 2, rotate = "oblimin", fm = "ml", n.obs = nrow(data_cfa_nc))
#list matrix of structure loadings
print(efa_obl2$Structure, cutoff = 0, digits = 3)
#list matrix of residual correlations
round(efa_obl2$residual, 3)
#compute factor scores after oblique rotation
scores_efaobl3 <- factor.scores(data_cfa_nc[,-1], efa_obl2,
                                method = "tenberge")
tables_nc <- fa_table(efa_obl2,
                        title = "Factor analysis results with oblique rotation
                        and two factors.",
                        varlabels = str_wrap(nc_key$question_text_english, 15))
# apply PCA
pca <- prcomp(data_cfa_nc[,-1])
scree1 <- screeplot(pca, type = "lines")#3 factors is likely better
ev <- eigen(cormat) # get eigenvalues
ap <- parallel(subject = nrow(data_cfa_nc), var = ncol(data_cfa_nc)-1,
  rep = 100, cent = .05)
nS <- nScree(x = ev$values, aparallel = ap$eigen$qevpea)
pdf(find_root_file(
    "data", "figures",
    "scree_nc.pdf", 
    criterion = has_file("baseball_thesis.Rproj")), width = 6.5, height = 4)
plotnScree(nS)
dev.off()

resid <- cormat -
   (crossprod(t(efa_obl2$loadings)) + diag(efa_obl2$uniquenesses))
n <- sum(ifelse(abs(resid) > 0.05, 1, 0)) / 2
non_redundant_factors <- n / (5*6/2)

#cronbach alpha
alpha_nc <- alpha(data_cfa_nc_unscaled %>%
                       dplyr::select(-child_id))
alpha_nc_nl <- alpha(data_cfa_nc_unscaled %>%
                       left_join(children %>%
                                   dplyr::select(child_id,
                                                 community)) %>%
                       dplyr::filter(str_detect(community, "Dutch")) %>%
                       dplyr::select(-child_id, -community))
alpha_nc_fr <- alpha(data_cfa_nc_unscaled %>%
                       left_join(children %>%
                                   dplyr::select(child_id,
                                                 community)) %>%
                       dplyr::filter(str_detect(community, "French")) %>%
                       dplyr::select(-child_id, -community))
```


In total, `r nrow(data_cfa_nc)` out of the `r nrow(children)` children filled in all of the Nature Connectedness questions and can therefor be analyzed further.
The scree plot in Figure \@ref(fig:nc-scree) shows that, according to the optimal coordinates method, one factor is best (as in the original scale). According to the acceleration factor method, two factors may be better. Explorative analysis showed that allowing for two factors resulted in one statement ("I always find nature very beautiful") being split off and "I always treat nature with respect" does not fit well in either factor. 
We therefor only explore the one-factor model further in this research.

```{r nc-scree, warning=FALSE, message=FALSE, fig.cap="Analysis of the number of component or factors to retain in an exploratory principal component or factor analysis.", echo=FALSE, include=TRUE}
knitr::include_graphics(find_root_file(
    "data", "figures",
    "scree_nc.pdf", 
    criterion = has_file("baseball_thesis.Rproj")))
```


We further analyse the Nature Connectedness scale by calculating Chronbach alpha.
The raw alpha value is `r round(unlist(unname(alpha_nc$total["raw_alpha"])), 2)` (`r round(unlist(unname(alpha_nc_nl$total["raw_alpha"])), 2)` in the Dutch and `r round(unlist(unname(alpha_nc_fr$total["raw_alpha"])), 2)` in the French questionnaire separately) which is slightly less than the original scale's chronbach alpha (0.899 in children, @hunt2017monitor) but still quite good.

Table \@ref(tab:nc-alpha) shows that Chronbach alpha can actually be increased if the statement "I always treat nature with respect." is removed (see first column in the table). As expected, this item also has the lowest item-scale correlation. In contrast, the original study reported that "I feel part of nature" was the statement that was least correlated with all other statements.

```{r nc-alpha, warning=FALSE, message=FALSE, echo=FALSE, include=TRUE}
alpha_nc$alpha.drop["raw_alpha"] %>%
  cbind(alpha_nc$item.stats[c("r.drop", "mean", "sd")]) %>%
  mutate(question_short = row.names(.)) %>%
  left_join(nc_key %>% dplyr::select(question_short, question_text_english)) %>%
  dplyr::select(question_text_english, raw_alpha, r.drop, mean, sd) %>%
  kable(booktabs = TRUE,
        escape = FALSE,
        caption = "Reliability if an item is dropped and item statistics.",
        digits = 3,
        col.names = c("item", "raw $\\alpha$", "item-scale corr.", "mean",
                      "std. dev.")) %>%
  kableExtra::kable_styling(font_size = 9) %>%
  kableExtra::column_spec(1, width = "3in") %>%
  kableExtra::column_spec(3, width = "0.7in")
```

\clearpage

### Outdoor play questionnaire in parents

```{r read_atop_p, message=FALSE, warning=FALSE, include=FALSE}
atop_data_p1 <- read_resource(package = baseball_package,
              resource_name = "wp5_parents_outdoor_play_data_part1")
atop_data_p2 <- read_resource(package = baseball_package,
              resource_name = "wp5_parents_outdoor_play_data_part2")
atop_data_p3 <- read_resource(package = baseball_package,
              resource_name = "wp5_parents_outdoor_play_data_part3")
atop_data_p4 <- read_resource(package = baseball_package,
              resource_name = "wp5_parents_outdoor_play_data_part4")
atop_key_p <- read_resource(package = baseball_package,
              resource_name = "wp5_parents_outdoor_play_key")
```

The parents were asked about how often their children play and what type of activities (both indoor and outdoor) they typically engage in. Since the response was disappointing at first, some questions were left out in a shortened version of the questionnaire to hopefully motivate parents to fill it in (see also Table \@ref(tab:atop-translation) in the Appendix).

Table \@ref(tab:atop-p-descriptives) shows the descriptives for each of the questions. Figures \@ref(fig:opp1) to \@ref(fig:opp3) show the same data visually for both languages separately.


```{r atop-p-descriptives, message=FALSE, warning=FALSE, include=TRUE, echo = FALSE}
nb <- length(unique(c(atop_data_p1$child_id, atop_data_p2$child_id,
                      atop_data_p2$child_id, atop_data_p4$child_id)))
tbl1 <- atop_data_p1 %>%
  group_by(question_short) %>%
  summarize(unit = str_remove(unique(unit), "number of "),
            s = sprintf("mean %.2f, (sd %.2f) %s", mean(response), sd(response), unit),
            n = n_distinct(child_id)) %>%
  ungroup() %>%
  dplyr::select(-unit, -n)
tbl2 <- atop_data_p2 %>%
  mutate(response = ifelse(response == "association", "yes",
                           ifelse(response == "no association",
                                  "no",
                                  "maybe"))) %>%
  group_by(question_short, response) %>%
  summarize(n = n_distinct(child_id)) %>%
  mutate(s = sprintf("%s: %d", response, n)) %>%
  arrange(question_short, desc(s)) %>%
  summarize(s = str_c(s, collapse = ", ")) %>%
  dplyr::filter(question_short != "other_outdoor_play")
tbl3 <- atop_data_p3 %>%
  dplyr::filter(str_length(response) < 5) %>% #only keep cases with 1 response or where both responses agree
  mutate(response = factor(as.factor(response),
                           levels = c("0", "< 1", "1-2", "2-3", "3-4", "> 4"))
         ) %>%
  group_by(question_short, unit, response) %>%
  summarize(n = n_distinct(child_id)) %>%
  mutate(s = sprintf("%s: %d", response, n)) %>%
  arrange(question_short, response) %>%
  summarize(s = str_c(s, collapse = ", ")) %>%
  mutate(s = str_c(unit, ":", s)) %>%
  dplyr::select(-unit) %>%
  ungroup()
tbl4 <- atop_data_p4 %>%
  dplyr::filter(!str_detect(response, "-")) %>% #only keep cases with 1 response or where both responses agree
  group_by(question_short, response) %>%
  summarize(n = n_distinct(child_id)) %>%
  mutate(s = sprintf("%s: %d", response, n)) %>%
  arrange(question_short, response) %>%
  summarize(s = str_c(s, collapse = ", "))

tbl1 %>%
  rbind(tbl2) %>%
  rbind(tbl3) %>%
  rbind(tbl4) %>%
  left_join(atop_key_p %>%
              dplyr::select(question_short, question_text_english)) %>%
  mutate(question_text_english =
           ifelse(startsWith(question_text_english, "How often"),
                             str_split_i(question_text_english,
                                         pattern = "/", i = 2),
                  question_text_english)) %>%
  dplyr::select(question_text_english, s) %>%
  kable(booktabs = TRUE, longtable = TRUE, 
        caption = "Descriptive statistics for outdoor play activities
        according to the parents.",
        col.names = c("Question", "Summary")) %>%
  kableExtra::kable_styling(latex_options = c("repeat_header"),
                            font_size = 9) %>%
  kableExtra::column_spec(1, width = "3in") %>%
  kableExtra::column_spec(2, width = "3in")
```

```{r opp1, message=FALSE, warning=FALSE, include=TRUE, echo = FALSE, fig.cap = "Descriptive statistics for Dutch-speaking (left) and French-speaking (right) children for the questions on how many days per week their child participate in...", fig.width = 6.5, fig.height = 4}
likert_data_atop <- atop_data_p1 %>%
  as.data.frame() %>%
  left_join(children) %>%
  dplyr::filter(!str_detect(community, "French")) %>%
  mutate(response = round(response)) %>%
  dplyr::select(activity, response) %>%
  pivot_wider(names_from = activity, values_from = response,
              values_fn = list)
likert_data_atop2 <- as.data.frame(do.call(cbind,
                                          sapply(1:ncol(likert_data_atop),
                                                 FUN = function(x) {
                                                   likert_data_atop[[x]]
                                          })))
colnames(likert_data_atop2) <- names(likert_data_atop)
likert_data_atop2 <- likert_data_atop2 %>%
  mutate_all(.funs = ~factor(as.factor(.x), levels = as.character(seq(0,7))))
p_nl <- gglikert(likert_data_atop2, sort = "none", y_label_wrap = 20,
                 labels_size = 2)
 

likert_data_atop <- atop_data_p1 %>%
  as.data.frame() %>%
  left_join(children) %>%
  dplyr::filter(str_detect(community, "French")) %>%
  mutate(response = round(response)) %>%
  dplyr::select(activity, response) %>%
  pivot_wider(names_from = activity, values_from = response,
              values_fn = list)
likert_data_atop2 <- as.data.frame(do.call(cbind,
                                          sapply(1:ncol(likert_data_atop),
                                                 FUN = function(x) {
                                                   likert_data_atop[[x]]
                                          })))
colnames(likert_data_atop2) <- names(likert_data_atop)
likert_data_atop2 <- likert_data_atop2 %>%
  mutate_all(.funs = ~factor(as.factor(.x), levels = as.character(seq(0,7))))

p_fr <- gglikert(likert_data_atop2, sort = "none", y_label_wrap = 20,
                 labels_size = 2)
p_nl + p_fr + plot_layout(guides = "collect") &
  theme(legend.position = "bottom",
        text = element_text(size = 9))
```

```{r opp2, message=FALSE, warning=FALSE, include=TRUE, echo = FALSE, fig.cap = "Descriptive statistics for Dutch-speaking (left) and French-speaking (right) children for the questions 'Do you associate the following activity as typical outdoor playing behavior of you child?'", fig.width = 6.5, fig.height = 6.5}
likert_data_atop <- atop_data_p2 %>%
  as.data.frame() %>%
  left_join(children) %>%
  dplyr::filter(!str_detect(community, "French")) %>%
  mutate(response = ifelse(response == "association",
                           "Yes", 
                           ifelse(response == "no association",
                                  "No", "Maybe"))) %>%
  dplyr::select(activity, response) %>%
  pivot_wider(names_from = activity, values_from = response,
              values_fn = list)
likert_data_atop2 <- as.data.frame(do.call(cbind,
                                          sapply(1:ncol(likert_data_atop),
                                                 FUN = function(x) {
                                                   likert_data_atop[[x]]
                                          })))
colnames(likert_data_atop2) <- names(likert_data_atop)
likert_data_atop2 <- likert_data_atop2 %>%
  mutate_all(.funs = ~factor(as.factor(.x),
                             levels = c("Yes", "Maybe", "No")))
p_nl <- gglikert(likert_data_atop2, sort = "none", y_label_wrap = 25,
                 labels_size = 2)
 

likert_data_atop <- atop_data_p2 %>%
  as.data.frame() %>%
  left_join(children) %>%
  dplyr::filter(str_detect(community, "French")) %>%
  mutate(response = ifelse(response == "association",
                           "Yes", 
                           ifelse(response == "no association",
                                  "No", "Maybe"))) %>%
  dplyr::select(activity, response) %>%
  pivot_wider(names_from = activity, values_from = response,
              values_fn = list)
likert_data_atop2 <- as.data.frame(do.call(cbind,
                                          sapply(1:ncol(likert_data_atop),
                                                 FUN = function(x) {
                                                   likert_data_atop[[x]]
                                          })))
colnames(likert_data_atop2) <- names(likert_data_atop)
likert_data_atop2 <- likert_data_atop2 %>%
  mutate_all(.funs = ~factor(as.factor(.x),
                             levels = c("Yes", "Maybe", "No")))

p_fr <- gglikert(likert_data_atop2, sort = "none", y_label_wrap = 25,
                 labels_size = 2)
p_nl + p_fr + plot_layout(guides = "collect") &
  theme(legend.position = "bottom",
        text = element_text(size = 9))
```

```{r opp3, message=FALSE, warning=FALSE, include=TRUE, echo = FALSE, fig.cap = "Descriptive statistics for Dutch-speaking (left) and French-speaking (right) children for the questions 'How many hours does your child spend on ... on an average weekday/weekend day?'", fig.width = 6.5, fig.height = 4}
likert_data_atop <- atop_data_p3 %>%
  as.data.frame() %>%
  left_join(children) %>%
  dplyr::filter(!str_detect(community, "French")) %>%
  mutate(
    activity = paste0(activity, "_", during),
    response = ifelse(response == "0 - < 1",
                      "0", 
                      ifelse(response == "< 1 - 1-2",
                             "1-2", ifelse(response == "1-2 - 2-3",
                                           "2-3",
                                           ifelse(str_detect(response, "3-4"),
                                                  "3-4", response))))) %>%
  dplyr::select(activity, response) %>%
  pivot_wider(names_from = activity, values_from = response,
              values_fn = list)
likert_data_atop2 <- as.data.frame(do.call(cbind,
                                          sapply(1:ncol(likert_data_atop),
                                                 FUN = function(x) {
                                                   likert_data_atop[[x]]
                                          })))
colnames(likert_data_atop2) <- names(likert_data_atop)
likert_data_atop2 <- likert_data_atop2 %>%
  mutate_all(.funs = ~factor(as.factor(.x),
                             levels = c("0", "< 1", "1-2", "2-3", "3-4",
                                        "> 4")))
p_nl <- gglikert(likert_data_atop2, sort = "none", y_label_wrap = 25,
                 labels_size = 2)
 
likert_data_atop <- atop_data_p3 %>%
  as.data.frame() %>%
  left_join(children) %>%
  dplyr::filter(str_detect(community, "French")) %>%
  mutate(
    activity = paste0(activity, "_", during),
    response = ifelse(response == "0 - < 1",
                      "0", 
                      ifelse(response == "< 1 - 1-2",
                             "1-2", ifelse(response == "1-2 - 2-3",
                                           "2-3",
                                           ifelse(str_detect(response, "3-4"),
                                                  "3-4", response))))) %>%
  dplyr::select(activity, response) %>%
  pivot_wider(names_from = activity, values_from = response,
              values_fn = list)
likert_data_atop2 <- as.data.frame(do.call(cbind,
                                          sapply(1:ncol(likert_data_atop),
                                                 FUN = function(x) {
                                                   likert_data_atop[[x]]
                                          })))
colnames(likert_data_atop2) <- names(likert_data_atop)
likert_data_atop2 <- likert_data_atop2 %>%
  mutate_all(.funs = ~factor(as.factor(.x),
                             levels = c("0", "< 1", "1-2", "2-3", "3-4",
                                        "> 4")))

p_fr <- gglikert(likert_data_atop2, sort = "none", y_label_wrap = 25,
                 labels_size = 2)
p_nl + p_fr + plot_layout(guides = "collect") &
  theme(legend.position = "bottom",
        text = element_text(size = 9))
```

These answers can be used to validate the answered that were received from the children wrt their attitude towards outdoor play. To do so, we first check whether there is a big difference in the children whose parents answered (`r nb` in total of which `r nb-length(unique(atop_data_p4$child_id))` answered the full (not shortened) questionnaire) and the children whose parents did not answer the questionnaire (`r nrow(children) - nb`). \@ref(tab:atop-p-response-difference) shows that relatively less Dutch-speaking parents answered the long questionnaire and they were more likely not to respond at all. We can see that the response was especially low in the Flemish (Dutch speaking) provinces of West-Vlaanderen, Vlaams-Brabant, Oost-Vlaanderen, and Antwerp.

```{r atop-p-response-difference, message=FALSE, warning=FALSE, include=TRUE, echo = FALSE}
children %>%
  mutate(response = ifelse(child_id %in% atop_data_p2$child_id &
                             !(child_id %in% atop_data_p4$child_id),
                           "long",
                           ifelse(child_id %in% atop_data_p4$child_id,
                                  "short", "none")),
         response = factor(as.factor(response),
                                     levels = c("long", "short", "none"))) %>%
  group_by(response) %>%
  summarize(Number = n(),
            #age = mean(age_202205),#age is not known if the parents did not fill in the survey
            Dutch = sum(community == "Dutch speaking"),
            French = sum(community == "French speaking"),
            Bilingual = sum(community == "Dutch speaking.French speaking"),
            `West-Vlaanderen` = sum(province_name == "West-Vlaanderen"),
            `Vlaams-Brabant` = sum(province_name == "Vlaams-Brabant"),
            `Oost-Vlaanderen` = sum(province_name == "Oost-Vlaanderen"),
            Antwerpen = sum(province_name == "Antwerpen"),
            Brussels = sum(province_name == "Brussels Capital Region"),
            Hainaut = sum(province_name == "Hainaut"),
            Liege = sum(province_name == "LiÃ¨ge"),
            Namur = sum(province_name == "Namur"),
            Luxembourg = sum(province_name == "Luxembourg")) %>%
  ungroup() %>%
  # mutate(across(Dutch : Luxembourg, ~ sprintf("%d, (%.2f%%)", .x, 100*.x / nb)),
  #        Number = as.character(Number)) %>%
  pivot_longer(
    cols = !response,
    names_to = "variable",
    values_to = "nb_perc") %>%
  pivot_wider(names_from = response,
              values_from = `nb_perc`) %>%
  mutate(rowsum = rowSums(across(where(is.numeric)))) %>%
  mutate(across(long:none, ~ sprintf("%d (%.2f%%)", .x, 100*.x / rowsum))) %>%
  dplyr::select(-rowsum) %>%
  kable(booktabs = TRUE,
        font_size = 9,
        caption = "Demographics for children whose parents filled in the long
        questionnaire, short questionnaire, or no questionnaire.",
        col.names = c("", "Long questionnaire", "Short questionnaire",
                      "No response")) %>%
  kableExtra::group_rows(group_label = "Number of children",
                        start_row = 1, end_row = 1) %>%
  kableExtra::group_rows(group_label = "Community",
                        start_row = 2, end_row = 4) %>%
  kableExtra::group_rows(group_label = "Province",
                        start_row = 5, end_row = 13)

```


ADD CORRELATIONS (+P_VALUES ZOALS IN BEYER 2015) BETWEEN EACH OF THE QUESTIONS AND THE FACTOR SCORE FOR ATOP_FEARS AND ATOP_BENEFITS HERE

\clearpage

### Risk engagement and protection survey in parents and guardians
```{r read_reps, message=FALSE, warning=FALSE, include=FALSE}
# a description of how to view and read the data from the data package
reps_data1 <- read_resource(package = baseball_package,
                            resource_name =
                              "wp5_parents_risk_protection_data_part1") %>%
  mutate(response = factor(as.factor(response),
                           levels = c("Strongly disagree", "Disagree",
                                      "Slightly disagree",
                                      "Neigher agree nor disagree",
                                      "Slightly agree", "Agree",
                                      "Strongly agree")))
  
reps_data2 <- read_resource(package = baseball_package,
              resource_name = "wp5_parents_risk_protection_data_part2") %>%
  mutate(response = factor(as.factor(response),
                           levels = c("Never", "Seldom", "Occassionally",
                                     "Sometimes", "Regularly", "Often",
                                     "Always")))
reps_data <- reps_data1 %>%
  mutate(response = as.numeric(response)) %>%
  rbind(reps_data2 %>%
          mutate(response = as.numeric(response)))
nb_parents_reps <- length(
  unique(c(
    str_c(reps_data1$child_id, reps_data1$replicate_id),
    str_c(reps_data2$child_id, reps_data2$replicate_id))))
nb_children_reps <- length(
  unique(c(reps_data1$child_id, reps_data2$child_id, reps_data2$replicate_id)))
reps_key <- cbind(reps_key, factor = c("protection_from_injury", "engagement_with_risk", "protection_from_injury", "engagement_with_risk", "protection_from_injury", "engagement_with_risk", "protection_from_injury", "engagement_with_risk", "protection_from_injury", "engagement_with_risk", "protection_from_injury", "engagement_with_risk", "rain", "wash_hands", "protection_from_injury","protection_from_injury"))
```


The Risk Engagement and Protection Survey was based on @olsen2018risk. This scale was also supplemented by two additional questions:

* 'How often do you allow your child to play outside when it is raining?', which was based on a question in @jelleyman2019cross.
* 'Should your child wash his/her hands after outdoor play?', which was added since washing hands often might influence the effect of outdoor play on the microbiome.

Figure \@ref(fig:reps-descriptives2) shows that Dutch and French speaking parents seem to answer slightly different. Dutch speaking parents answered more positive, on average, on the "risk engagement" statements (statement 1 to 6 in Figure \@ref(fig:reps-descriptives2)) and more negative on the "protection from injury" statements (statement 7 to 14 in Figure \@ref(fig:reps-descriptives2)). 

Since this involves many statements (14 from REPS and 2 additional ones), these statements were removed from the shortened questionnaire to encourage overall response rate for the most important questions for the B@seball project's goals. All statements were answered on a 7-point likert scale. Some questions were coded from "Strongly disagree" to "Strongly agree" while others were coded "Never" to "Always". Finally, only `r nb_parents_reps` parents of `r nb_children_reps` children answered the REPS scale items (for some children, more than one parent answered the survey). 

For REPS, it is hypothesized that there are two underlying factors: "Protection from injury" and "Engagement with risk" [@@olsen2018risk]. We will test in exploratory factor analysis whether the two additional statements about playing in the rain and washing hands can improve the REPS scale.

Due to a mistake, the question on washing hands ("Should your child wash his/her hands after outdoor play?) was not included in the french survey (last column and row in Table \@ref(tab:reps-descriptives)). We therefor use the *mifa* package to execute an exploratory factor analysis with multiple imputation. 

```{r reps-descriptives, message=FALSE, warning=FALSE, include=TRUE, echo = FALSE}
nb <- length(unique(reps_data$child_id))
reps_data %>%
  full_join(expand_grid(
    child_id = unique(reps_data$child_id),
    question_short = unique(reps_data$question_short))) %>%
  group_by(question_short, response) %>%
  summarize(n = n()) %>%
  ungroup() %>%
  mutate(summ = sprintf("%.0f (%.0f%%)", n, n/nb*100)) %>%
  left_join(reps_key %>% dplyr::select(question_short, question_text_english)) %>%
  dplyr::select(-n, -question_short) %>%
  pivot_wider(names_from = response,
              values_from = summ) %>% 
  mutate_at(2:8, ~replace_na(.,"")) %>%
  kable(booktabs = TRUE,
        caption = "Descriptive statistics for REPS in parents.",
        col.names = c("Original statement", as.character(1:7),
                      "Not answered")) %>%
  kableExtra::kable_styling(font_size = 8) %>%
  kableExtra::column_spec(1, width = "1.6in") %>%
  kableExtra::column_spec(2:9, width = "0.45in")
```

```{r reps-descriptives2, message=FALSE, warning=FALSE, include=TRUE, echo = FALSE, fig.cap = "Descriptive statistics for Dutch-speaking (left) and French-speaking (right) parents for the REPS scale items.", fig.width = 6.5, fig.height = 6.5, eval = TRUE}
likert_data_reps <- reps_data %>%
  as.data.frame() %>%
  rbind(c("10-5X-03", "1", "Single response", "wash_hands", "x6_14", NA)) %>% #this line is missing from the data
  left_join(children) %>%
  dplyr::filter(str_detect(community, "Dutch speaking")) %>%
  dplyr::select(question_short, response) %>%
  pivot_wider(names_from = question_short, values_from = response,
              values_fn = list)
likert_data_reps2 <- as.data.frame(do.call(cbind,
                                          sapply(1:ncol(likert_data_reps),
                                                 FUN = function(x) {
                                                   likert_data_reps[[x]]
                                          })))
colnames(likert_data_reps2) <- names(likert_data_reps)
likert_data_reps <- likert_data_reps2 %>%
  dplyr::select(reps_key %>%
                  arrange(factor) %>%
                  dplyr::pull(question_short))#order according to the factor
names(likert_data_reps) <-
  unname(unlist(reps_key[
    match(names(likert_data_reps),reps_key$question_short),
    "question_text_english"]))
p_nl <- gglikert(likert_data_reps, sort = "none", y_label_wrap = 25,
                 labels_size = 1.5)


#How often is each question answered in each of the communities?
nb_answered <- reps_data %>%
  left_join(children) %>% 
  group_by(question_code, question_short, community) %>%
  summarize(n = n_distinct(child_id)) %>%
  ungroup()
#wash_hands is never answered in the french community 
  
  
full_available <- reps_data %>%
  group_by(child_id) %>%
  summarize(n = n()) %>%
  mutate(rest = (n %% 16)) %>%
  left_join(children) %>% 
  filter((community == "Dutch speaking" & n %% 16 == 0) |
           (community == "French speaking" & n %% 15 == 0)) %>%
  dplyr::pull(child_id) #parents of these children filled in all questions


likert_data_reps <- reps_data %>%
  as.data.frame() %>%
  left_join(children) %>%
  dplyr::filter(str_detect(community, "French speaking") &
                  child_id %in% full_available) %>%
  dplyr::select(question_short, response) %>%
  pivot_wider(names_from = question_short, values_from = response,
              values_fn = list)
likert_data_reps2 <- as.data.frame(do.call(cbind,
                                          sapply(1:(ncol(likert_data_reps)),
                                                 FUN = function(x) {
                                                   likert_data_reps[[x]]
                                          })))
colnames(likert_data_reps2) <- names(likert_data_reps)
likert_data_reps <- likert_data_reps2 %>%
  dplyr::select(reps_key %>%
                  dplyr::filter(reps_key$question_short != "wash_hands") %>%
                  arrange(factor) %>%
                  dplyr::pull(question_short))
names(likert_data_reps) <-
  unname(unlist(reps_key[
    match(names(likert_data_reps),reps_key$question_short),
    "question_text_english"]))
factorize <- function(x){
  out <- factor(as.factor(x), levels = as.character(seq(1,7)))
  return(out)
}
p_fr <- likert_data_reps %>%
  mutate_at(1:15, factorize) %>%
  gglikert(sort = "none", y_label_wrap = 25,
           labels_size = 1.5)

p_nl + p_fr + plot_layout(guides = "collect") &
  theme(legend.position = "bottom",
        text = element_text(size = 8))

#------------------------Prepare REPS data for cfa-----------------------------#
#there are no parents who filled it in more than once 
answer_more_than_once <- reps_data %>%
  group_by(child_id, replicate_id, question_short) %>%
  summarise(n = dplyr::n(), .groups = "drop") %>%
  dplyr::filter(n > 1L)
#reshape the data into the proper format
data_cfa_reps <- reps_data %>%
  full_join(expand_grid(#add a row for the missing "wash hands" data
    child_id = unique(reps_data$child_id),
    question_short = unique(reps_data$question_short))) %>%
    dplyr::select(child_id, replicate_id, question_short, response) %>%
  pivot_wider(id_cols = c(child_id, replicate_id), names_from = question_short,
               values_from = response) %>%
   dplyr::select(child_id, replicate_id, reps_key$question_short)
data_cfa_reps_unscaled <- data_cfa_reps
data_cfa_reps[, -c(1, 2)] <- scale(data_cfa_reps[, -c(1, 2)],
                                   center = TRUE, scale = FALSE)
```



```{r message=FALSE, warning=FALSE, include=FALSE, echo = FALSE, eval = FALSE}
#-------------1. Analysing only complete data (no missing answers)-------------#
df <- data_cfa_reps[complete.cases(data_cfa_reps[, -c(1, 2)]), -c(1, 2)]
pca <- prcomp(df)
scree1 <- screeplot(pca, type = "lines")#2 factors is best
covmat <- cov(data_cfa_reps[complete.cases(data_cfa_reps), -c(1, 2)])
cormat <- cor(data_cfa_reps[complete.cases(data_cfa_reps), -c(1, 2)])
efa_complete <- fa(cormat,
                   covar = FALSE,
                   2, rotate = "oblimin",
                   fm = "ml", n.obs = nrow(df))
tables_efa_complete <- fa_table(efa_complete,
                         title = "Factor analysis results with oblique rotation
                         and two factors.",
                         varlabels = str_wrap(reps_key$question_text_english,
                                              15))
tables_efa_complete$ind_table
#the two additional statements do not fit in either of the factors.
#the EFA further uncovers the original two factors although the statement "I encourage my child to do physical activity" is now part of the engagement with risk factor in stead of the protection factor.

#--------------------------------2. EFA with MI--------------------------------#
library(mifa)
mi <- mifa(data = data_cfa_reps[,-c(1, 2)])
fit <- fa(mi$cov_combined, n.obs = nrow(data_cfa_reps), nfactors = 2)
fa.diagram(fit)
tables_atop <- fa_table(fit,
                         title = "Factor analysis results with oblique rotation
                         and two factors.",
                         varlabels = str_wrap(reps_key$question_text_english,
                                              15))
tables_atop$ind_table
#Again, the washing hands and playing in the rain statements don't fit with
# either factor. "I encourage my child to do physical activity (with the least 
# risk of injury)." also does not fit well with either.
```

Three different CFA were tested on the `r sum(complete.cases(data_cfa_reps %>%
  dplyr::select(-wash_hands, -play_in_rain)))` responses of parents who filled in all of the 14 REPS statements and the best fitting model was kept. Firstly, the originally suggested model from @olsen2018risk was fit. Chronbach alpha for the "protection from injury" factor was only 0.75. Especially the statement "I encourage my child to do physical activity (with the least risk of injury)" did not fit well. The EFA that were tested too see whether the two additional statements would fit the REPS scale already indicated that this statement might fit better in the "risk engagement" factor. A second model therefor includes "I encourage my child to do physical activity (with the least risk of injury)" as a risk_engagement statement. However, this did not improve fit and, finally, it was decided to drop this problematic statement. 

```{r reps-cfa, message=FALSE, warning=FALSE, include=FALSE, echo = FALSE, eval = FALSE}
#------------------------------3. CFA only for original REPS-------------------#
data_cfa_reps_only <- data_cfa_reps %>%
  dplyr::select(-wash_hands, -play_in_rain)
covmat <- cov(data_cfa_reps_only[complete.cases(data_cfa_reps_only), -c(1, 2)])
cormat <- cor(data_cfa_reps_only[complete.cases(data_cfa_reps_only), -c(1, 2)])
#exploratory factor analysis on correlation matrix with 3 factors and oblique rotation
efa_obl2 <- fa(cormat, covar = FALSE, 2, rotate = "oblimin", fm = "ml", n.obs = sum(complete.cases(data_cfa_reps_only)))
#list matrix of structure loadings
print(efa_obl2$Structure, cutoff = 0, digits = 3)
#list matrix of residual correlations
round(efa_obl2$residual, 3)
#compute factor scores after oblique rotation
scores_efaobl2 <- factor.scores(data_cfa_reps_only[, -c(1, 2)], efa_obl2,
                               method = "tenberge")
tables_atop <- fa_table(efa_obl2,
                       title = "Factor analysis results with oblique rotation
                       and two factors.",
                       varlabels =
                         str_wrap(reps_key[-c(13, 14), "question_text_english"],
                                  15))
#"I encourage my child to do physical activity (with the least risk of injury)." does not work well in both factors
parents_model_REPS <- "protection_from_injury =~ NA * concerned_injury + prevention_importance + concerned_hazards + avoid_risk + importance_supervision + chance_of_injury + encourage_safe_activities + limit_dangerous_activities
          risk_engagement =~ NA * promote_physical_challenges + physical_limits + explore_new_environments + benefits_outweigh_risk + importance_managing_risk + risk_self_confidence
          protection_from_injury ~~ 1 * protection_from_injury
          risk_engagement ~~ 1 * risk_engagement
          protection_from_injury ~~ risk_engagement"

parents_model_REPS_alt <- "protection_from_injury =~ NA * concerned_injury + prevention_importance + concerned_hazards + avoid_risk + importance_supervision + chance_of_injury + limit_dangerous_activities
          risk_engagement =~ NA * promote_physical_challenges + physical_limits + explore_new_environments + benefits_outweigh_risk + importance_managing_risk + risk_self_confidence + encourage_safe_activities
          protection_from_injury ~~ 1 * protection_from_injury
          risk_engagement ~~ 1 * risk_engagement
          protection_from_injury ~~ risk_engagement"
parents_model_REPS_alt2 <- "protection_from_injury =~ NA * concerned_injury + prevention_importance + concerned_hazards + avoid_risk + importance_supervision + chance_of_injury + limit_dangerous_activities
          risk_engagement =~ NA * promote_physical_challenges + physical_limits + explore_new_environments + benefits_outweigh_risk + importance_managing_risk + risk_self_confidence 
          protection_from_injury ~~ 1 * protection_from_injury
          risk_engagement ~~ 1 * risk_engagement
          protection_from_injury ~~ risk_engagement"

fitcfa <- lavaan::cfa(parents_model_REPS, data = data_cfa_reps_only)
fitcfa_alt <- lavaan::cfa(parents_model_REPS_alt, data = data_cfa_reps_only)
fitcfa_alt2 <- lavaan::cfa(parents_model_REPS_alt2, data = data_cfa_reps_only)
summary(fitcfa, fit.measure = TRUE)
modificationIndices(fitcfa)# how can we improve the model?

library(semTools)
reliability(fitcfa) #shows chronbach alpha and other reliability measures
compRelSEM(fitcfa) 
alpha_reps_pi <- alpha(data_cfa_reps_unscaled %>%
                         dplyr::select(
                           reps_key[reps_key$factor == "protection_from_injury",
                                    "question_short"]),
                       check.keys = TRUE)
alpha_reps_pi_fr <- alpha(data_cfa_reps_unscaled %>%
                           left_join(children) %>%
                           dplyr::filter(str_detect(community, "French")) %>%
                         dplyr::select(
                           reps_key[reps_key$factor == "protection_from_injury",
                                    "question_short"]),
                       check.keys = TRUE) #99 complete cases
alpha_reps_pi_nl <- alpha(data_cfa_reps_unscaled %>%
                           left_join(children) %>%
                           dplyr::filter(!str_detect(community, "French")) %>%
                         dplyr::select(
                           reps_key[reps_key$factor == "protection_from_injury",
                                    "question_short"]),
                       check.keys = TRUE) #124 complete cases
#alpha_reps_pi$alpha.drop shows that reliability is better if the
#  encourage_safe_activities statement is removed from the scale.
#the fit is also much better in the Dutch than in the French translation
alpha_reps_re <- alpha(data_cfa_reps_unscaled %>%
                         dplyr::select(
                           reps_key[reps_key$factor == "engagement_with_risk",
                                    "question_short"]),
                       check.keys = TRUE)
alpha_reps_re_fr <- alpha(data_cfa_reps_unscaled %>%
                           left_join(children) %>%
                           dplyr::filter(str_detect(community, "French")) %>%
                         dplyr::select(
                           reps_key[reps_key$factor == "engagement_with_risk",
                                    "question_short"]),
                       check.keys = TRUE)#102 complete answers
alpha_reps_re_nl <- alpha(data_cfa_reps_unscaled %>%
                           left_join(children) %>%
                           dplyr::filter(!str_detect(community, "French")) %>%
                         dplyr::select(
                           reps_key[reps_key$factor == "engagement_with_risk",
                                    "question_short"]),
                       check.keys = TRUE) #125 complete answers
#again, the dutch translation is much better than the french (alpha .79 in stead of .62, .8 in total dataset)
```





\clearpage
### Independent mobility in parents

Lastly, the parents some questions on independent mobility, inspired by @shaw2013children. 
Since the original authors do not provide guidelines for any underlying latent factors, we perform an exploratory factor analysis first.

To improve response rate, these questions were left out in a shortened version of the survey. 
Therefor, the number of responses is greatly reduced.
Table \@ref(tab:im-descriptives) shows the descriptives

```{r read_im, message=FALSE, warning=FALSE, include=FALSE}
# a description of how to view and read the data from the data package
im_data <- read_resource(package = baseball_package,
                            resource_name =
                              "wp5_parents_independent_mobility_data") %>%
  mutate(response = factor(as.factor(response),
                           levels = c("No", "Yes - No", "Yes")))
```

```{r im-descriptives, message=FALSE, warning=FALSE, include=TRUE, echo = FALSE}
nb <- length(unique(paste0(im_data$child_id, im_data$replicate_id)))
tbl <- im_data %>%
  group_by(question_short, response) %>%
  summarize(n = n()) %>%
  ungroup() %>%
  mutate(summ = sprintf("%.0f (%.0f%%)", n, n/nb*100)) %>%
  left_join(im_key %>% dplyr::select(question_short, question_text_english)) %>%
  dplyr::select(-n, -question_short) %>%
  pivot_wider(names_from = response,
              values_from = summ)  %>% 
  mutate_at(2:4, ~replace_na(.,"")) %>%
  dplyr::select(question_text_english, No, `Yes - No`, Yes)
tbl[order(match(tbl$question_text_english, im_key$question_text_english)),] %>%
  kable(booktabs = TRUE,
        caption = "Descriptive statistics for Attitude Towards Outdoor Play
        scale items in children.",
        col.names = c("Item", "No", "Yes - No", "Yes")) %>%
  kableExtra::kable_styling(font_size = 9) %>%
  kableExtra::column_spec(1, width = "2in") %>%
  kableExtra::column_spec(2:4, width = "0.6in")
```


\clearpage
### Conclusion on the scale questions

\clearpage
## Structural equation model (SEM)

