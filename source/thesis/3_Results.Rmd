
```{r message=FALSE, warning=FALSE, include=FALSE}
# a description of how to view and read the data from the data package
baseball_package <- read_package(
  find_root_file("data", "processed", "datapackage_analysis",
    "datapackage.json", 
    criterion = has_file("baseball_thesis.Rproj")))
#overview of all resources (=datasets) in the data package
resources(baseball_package)
#Extract a single resource and assign it to a R object
wp3_ua_sirm_data <- read_resource(package = baseball_package,
                               resource_name = "wp3_ua_sirm_data")
#inspect the description
get_schema(package = baseball_package,
           resource_name = "wp3_ua_sirm_data")$fields %>%
  bind_rows() %>%
  kable(booktabs = TRUE) %>%
  kableExtra::kable_styling()

#General data about the parents
gen_data <- read_resource(package = baseball_package,
              resource_name = "wp5_parents_general_questions_data")
gen_key <- read_resource(package = baseball_package,
              resource_name = "wp5_parents_general_questions_key")

#allergy
allergy_data <- read_resource(package = baseball_package,
              resource_name = "wp5_parents_allergy_related_questions_data")
allergy_key <- read_resource(package = baseball_package,
              resource_name = "wp5_parents_allergy_related_questions_key")

#culture
culture_data <- read_resource(package = baseball_package,
              resource_name = "wp5_parents_cultural_background_data")
culture_key <- read_resource(package = baseball_package,
              resource_name = "wp5_parents_cultural_background_key")

#socio-economic status
ses_data <- read_resource(package = baseball_package,
              resource_name = "wp5_parents_ses_questions_data")
ses_key <- read_resource(package = baseball_package,
              resource_name = "wp5_parents_ses_questions_key")

#living environment
liv_envir_data <- read_resource(package = baseball_package,
              resource_name = "wp5_parents_living_environment_data")
liv_envir_key <- read_resource(package = baseball_package,
              resource_name = "wp5_parents_living_environment_key")
```

# Results

## Data exploration 

### Demographics
```{r message=FALSE, warning=FALSE, include=FALSE}
data_school <- read_resource(package = baseball_package,
                             resource_name = "wp2_school_data")
data_particip <- read_resource(package = baseball_package,
                               resource_name = "wp2_participants_metadata")
```

While the initial goal was to get over 70 schools on board, only `r nrow(data_school)` were willing to participate.
The Covid 19 epidemic may also have had an impact on this disappointing response rate.

```{r schools-size, fig.cap = "Number of schools per province (number on the left) and school size.", message=FALSE, warning=FALSE, echo=FALSE, fig.height = 4}
ordered_provinces <- c(data_school %>%
                     filter(province_name != "Brussels Capital Region") %>%
                     arrange(community, province_name) %>%
                     dplyr::pull(province_name) %>%
                     unique(), "Brussels Capital Region")
school_by_province <- data_school %>%
  group_by(province_name) %>%
  summarize(n = n())
school_by_community <- data_school %>%
  group_by(community) %>%
  summarize(n = n())
data_school %>%
  mutate(province_name = factor(as.factor(province_name),
                                levels = ordered_provinces,
                                ordered = TRUE)) %>%
  ggplot(aes(x = n_students, y = province_name)) +
  geom_point(aes(color = community)) +
  geom_text(data = school_by_province,
            aes(x = min(data_school$n_students) - 20,
                y = province_name,
                label = n)) +
  xlab("Number of students in the school") +
  ylab("Province") +
  theme_bw() +
  scale_color_discrete("Language",
                       breaks = c("French speaking", "Dutch speaking",
                                  "Dutch speaking.French speaking"),
                       labels = c("French-speaking", "Dutch-speaking",
                                  "Bilingual"))
```


Figure \@ref(fig:schools-size) shows that there are `r unname(unlist(school_by_community[1,"n"]))` Dutch-speaking schools, `r unname(unlist(school_by_community[3,"n"]))` French-speaking schools, and `r unname(unlist(school_by_community[2,"n"]))` bilingual school.
It is remarkable to see in Figure Figure \@ref(fig:schools-size) and \@ref(fig:paticip-age-sex) that there are no schools from Limburg and only one from Vlaams-Brabant.
Overall, the balance between boys and girls is good. Most children were the same age and born in 2011 (Figure \@ref(fig:paticip-age-sex)).

```{r paticip-age-sex, fig.cap = "Year of birth (if known) and sex of the participating child. The numbers on the left show the total number of children in each group.", fig.height = 6, warning = FALSE, message = FALSE}
data_particip <- data_particip %>%
  left_join(data_school) %>%
  mutate(province_name = factor(as.factor(province_name),
                                levels = ordered_provinces,
                                ordered = TRUE))
nb_child_by_province <- 
  data_particip %>%
  filter(!is.na(biological_sex)) %>%
  group_by(biological_sex, province_name) %>%
  summarize(n = n()) %>%
  ungroup()
labels <- c("Antw", "O-Vl", "Vl-Br",
                   "W-Vl", "Hain", "Liège", "Luxem",
                   "Namur", "Brus")
names(labels) <- c("Antwerpen", "Oost-Vlaanderen", "Vlaams-Brabant",
                   "West-Vlaanderen", "Hainaut", "Liège", "Luxembourg",
                   "Namur", "Brussels Capital Region")
data_particip %>% 
  filter(!is.na(biological_sex)) %>%
  mutate(birth_year = ifelse(is.na(birth_year), "Unknown",
                             as.character(birth_year))) %>%
  ggplot(aes(x = birth_year, fill = biological_sex), position = dodge) +
  geom_bar() +
  geom_text(data = nb_child_by_province, aes(x = "2010", label = n,  y = 35)) +
  facet_grid(rows = vars(province_name),
             cols = vars(biological_sex),
             labeller = labeller(province_name = labels)) +
  ylab("") + xlab("birth year") +
  theme(legend.position = "bottom") + theme_bw()
```

```{r nb-years-in-school, fig.cap = "The figure on the left shows how long the children have been at their current school and how many years they spent in primary school. The right figure shows the  relation of the parent to the child.", message=FALSE, warning=FALSE}
p1 <- gen_data %>%
  group_by(years_at_school, years_primary) %>%
  summarize(n = n()) %>%
  ungroup() %>%
  ggplot() +
  geom_raster(aes(x = years_at_school, y = years_primary, fill = n)) +
  geom_text(aes(x = years_at_school, y = years_primary, label = n,
                color = (n < 75))) +
  scale_color_manual(values = c("black", "white"),
                     breaks = c(FALSE, TRUE),
                     guide = "none") +
  scale_fill_continuous(guide = "none") +
  xlab("number of years in their current school") +
  ylab("number of years in primary school") +
  theme_bw()

p2 <- gen_data %>%
  ggplot() +
  geom_bar(aes(x = respondent_relation)) +
  xlab("Relation to the child") +
  ylab("Number of parents") +
  theme_bw() +
  scale_x_discrete(labels = function(x) str_remove(str_wrap(x, width = 10),
                                                   "\\(fill in\\)"))
p1 + p2 +  plot_layout(widths = c(2, 1))
```

The parents' survey had a lower response rate. For those parents that did fill in the survey, the mean age was `r round(mean(2022 - gen_data$respondent_birth_year, na.rm = TRUE), 0)` years old.
Figure \@ref(fig:nb-years-in-school) shows that the mother usually filled in the parent's survey.
The figure on the left in Figure \@ref(fig:nb-years-in-school) shows that most children have been in the same primary school for 5 years now.
However, there is quite some variation where some children have switched schools, may have skipped a year or had to re-do some years.
For the B@seball project's main research questions on the link between school environment and the children's microbiome, it is important to see that most children have spend quite some years at the same school already.




```{r message=FALSE, warning=FALSE, include = FALSE}
#get schools data
baseball_derived_package <- read_package(
  find_root_file(
    "data", "processed", "datapackage_derived_data",
    "datapackage.json",
    criterion = has_file("baseball_thesis.Rproj")))
schools <- read_resource(package = baseball_derived_package,
              resource_name = "wp1_school_level_key_variables")
child_derived <- read_resource(package = baseball_derived_package,
              resource_name = "wp1_child_level_key_variables")
```

### School environment

The school environment is of particular interest for the B@seball project. It is characterized at two levels; within the school and outside the school.

Firstly, the playground biodiversity is assessed based on the amount of natural elements (water, vegetation, woodchips, gravel, etc.) and artificial elements (pavingstones, asphalt, etc.) in the playground. Based on the area of natural and artificial elements, and how often they are used by the children, the schools are divided into two groups. Those with a relatively green playground (high greenness) and those with a relatively grey playground (low greenness).

Secondly, since schools do not operate in a vacuum, it is also important to look at the landscape around the school. The area and proportion of area that is covered by grassland, trees and shrubs is calculated:

- Within the playground (in case of several playgrounds, the areas are summed).
- Within the school limit, but excluding the playground(s).
- Within 100m surrounding the school limit, but excluding the area within the school limit.
- Within 300m surrounding the school limit, but excluding the area of the 100 m buffer.

Using k-means clustering, the schools are divided into two groups; those within a relatively green environment (high naturalness) and those within a rural or grey environment (low naturalness).

Figure \@ref(fig:eda-school-greenery) shows the number of schools and children in each quadrant. Overall, each quadrant is quite well represented. 

```{r eda-school-greenery, fig.cap="Number of schools (left) and number of children with a high or low naturalness and greenness.", message=FALSE, warning=FALSE, fig.height = 4}
p1 <- schools %>%
  group_by(landscape_type, school_context) %>%
  summarize(n = n()) %>%
  ungroup() %>%
  ggplot(aes(x = as.factor(school_context), y = as.factor(landscape_type))) +
  geom_tile(aes(fill = n)
            ) +
  geom_text(aes(label = n), color = "white") +
  theme_bw() +
  xlab("school context (playground)") +
  ylab("landscape type (school surroundings)") +
  theme(legend.position = "none")
p2 <- children %>%
  left_join(schools %>% dplyr::select(school_id, landscape_type,
                                      school_context)) %>%
  group_by(landscape_type, school_context) %>%
  summarize(n = n()) %>%
  ungroup() %>%
  ggplot(aes(x = as.factor(school_context), y = as.factor(landscape_type))) +
  geom_tile(aes(fill = n)
            ) +
  geom_text(aes(label = n), color = "white") +
  theme_bw() +
  xlab("school context (playground)") +
  ylab("landscape type (school surroundings)") +
  theme(legend.position = "none",
        axis.title.y = element_blank(),
        axis.text.y = element_blank(),
        axis.ticks.y = element_blank())
p1 + p2 + 
  plot_layout(widths = c(1, 1))
```

### Socio-economic status

The socio-economic status (SES) is available at the school and child level. It is calculated based on the education level, employment, and the (combined) income of the parents [@reynders2005ses]:

- Education level parents score:
  - Primary education: 0
  - Secondary education: 1/3
  - Higher education: 2/3
  - University: 1
- Employment score (for respondent, as well as partner):
  - unemployed: 0
  - labourer: 1/3
  - civil servant, servant and small entrepreneur: 2/3
  - executive: 1
- (Combined) income score:
  - $<$ €1000: 0
  - Between €1000 and €2000: 1/5
  - Between €2000 and €3000: 2/5
  - Between €3000 and €4000: 3/5
  - Between €4000 and €5000: 4/5
  - $>$ €5000: 1

These scores (all with values between 0 and 1) were first averaged per child to get the child-level SES. Then, it is averaged over children per school to arrive at a school-level SES. Questions on employment, education level, and income are all included in the parents' survey. Since there are far less parents who filled in the survey than there are children in the data, the school-level SES may serve as a proxy for the child's SES if their parents did not fill in the survey.

Figure \@ref(fig:eda-ses) shows the schools, ordered by the school-level SES as shown by the red dots. The smaller dots represent the children and their color indicate the type of playground (greenness) and landscape (naturalness). The percentages on the right indicate the percentage of children in the school for which the SES could not be calculated.

```{r eda-ses, fig.cap = "Socio-economic status distributions in each of the schools.", message=FALSE, warning=FALSE}
no_ses <- 
  child_derived %>%
  group_by(school_id) %>%
  summarize(n = n(),
            nb_missing = sum(is.na(ses))) %>%
  ungroup() %>%
  mutate(perc_missing = sprintf("%.0f%%", nb_missing / n * 100))
child_derived %>%
  left_join(schools %>%
              dplyr::select(school_id, landscape_type,
                            school_context, ses) %>%
              rename(ses_school = ses)) %>%
  mutate(school_type = sprintf("%s - %s", school_context, landscape_type)) %>%
  ggplot(aes(y = school_id, color = as.factor(school_type))) +
  geom_point(aes(x = ses)) +
  geom_text(data = no_ses, aes(label = perc_missing, x = 1.1), color = "black",
            size = 2.5) +
  geom_point(data = schools, aes(x = ses), color = "red", size = 2) +
  scale_color_manual("",
                       breaks = c("low greenness - low naturalness",
                                  "low greenness - high naturalness",
                                  "high greenness - low naturalness",
                                  "high greenness - high naturalness"),
                       values = c("gray73", "khaki3", "olivedrab3",
                                  "darkgreen")) +
  theme_bw() +
  ylab("school") +
  xlab("socio-economic status") +
  scale_x_continuous(breaks = c(0, 0.25, .5, .75, 1)) +
  scale_y_discrete(limits = schools %>% arrange(ses) %>%
                     dplyr::pull(school_id)) +
  theme(legend.position = "bottom") +
  guides(color = guide_legend(nrow = 2, byrow = TRUE)) 
  

```

## Scale questions

### Attitude towards outdoor play (ATOP) in kids

```{r read_atop, message=FALSE, warning=FALSE, include=FALSE}
# a description of how to view and read the data from the data package
atop_data <- read_resource(package = baseball_package,
              resource_name = "wp5_atop_data")
atop_key <- read_resource(package = baseball_package,
              resource_name = "wp5_atop_questions")
#inspect the description
get_schema(package = baseball_package,
           resource_name = "wp5_atop_data")$fields %>%
  bind_rows() %>%
  kable(booktabs = TRUE) %>%
  kableExtra::kable_styling()
```

Among the `r nrow(children)` children that were selected for the study, `r length(unique(atop_data$child_id))` children filled in the ATOP questions. Table \@ref(tab:atopkids-descriptives) shows the descriptive statistics for ATOP scale items in all children.

Figure \@ref(fig:atopkids-descriptives2) in the appendix graphically shows the descriptive statistics for Dutch-speaking and French-speaking children separately. The answers are similar in both groups though French-speaking children are markedly less afraid of getting lost in nature.

```{r atopkids-descriptives, message=FALSE, warning=FALSE, include=TRUE, echo = FALSE}
nb <- length(unique(atop_data$child_id))
tbl <- atop_data %>%
  group_by(question_short, interpretation) %>%
  summarize(n = n()) %>%
  ungroup() %>%
  mutate(summ = sprintf("%.0f (%.0f%%)", n, n/nb*100)) %>%
  left_join(atop_key %>% dplyr::select(question_short, question_text_english)) %>%
  dplyr::select(-n, -question_short) %>%
  pivot_wider(names_from = interpretation,
              values_from = summ)  %>% 
  mutate_at(2:6, ~replace_na(.,"")) %>%
  dplyr::select(question_text_english, Disagree, `Slightly disagree`,
                `Moderately agree`, Agree, `No response`)
tbl[order(match(tbl$question_text_english, atop_key$question_text_english)),] %>%
  kable(booktabs = TRUE,
        caption = "Descriptive statistics for Attitude Towards Outdoor Play
        scale items in children.",
        col.names = c("Item", "Disagree", "Slightly disagree",
                     "Moderately agree", "Agree", "No response")) %>%
  kableExtra::kable_styling(font_size = 9) %>%
  kableExtra::column_spec(1, width = "2in") %>%
  kableExtra::column_spec(2:6, width = "0.6in")
```

```{r atop-fit-model, message=FALSE, warning=FALSE, include = FALSE}
#inspect the description
get_schema(package = baseball_package,
           resource_name = "wp5_atop_data")$fields %>%
  bind_rows() %>%
  kable(booktabs = TRUE) %>%
  kableExtra::kable_styling()
#reshape the data for cfa
likert_data_atop <- atop_data %>%
  as.data.frame() %>%
  mutate(interpretation = ifelse(interpretation == "No response",
                                 NA, interpretation),
         interpretation = factor(as.factor(interpretation),
                                 levels = c("Disagree", "Slightly disagree",
                                            "Moderately agree", "Agree"),
                                 ordered = TRUE)) %>%
  dplyr::select(question_short, interpretation, child_id) %>%
  pivot_wider(names_from = question_short, values_from = interpretation,
              id_cols = child_id) %>%
  left_join(children) %>%
  left_join(schools) 
model_atop <- "ATOP_benefits =~ 1*think_clearly + good_for_health + calm_down + learn_new_things +   feeling_free + imagination + explore 
  ATOP_fears =~ 1*get_lost + unknown_persons + wild_animals + getting_hurt
  calm_down ~~ learn_new_things
  calm_down ~~ feeling_free"
fit_free_atop <- cfa(model_atop,
                 data = likert_data_atop %>%
                   filter(community != "Dutch speaking.French speaking") %>%
                   mutate(across(think_clearly:getting_hurt,
                                 function(x) as.numeric(x))),
                 group = "community")
fit_sameloadings_atop <- cfa(model_atop,
                        data = likert_data_atop %>%
                          filter(community !=
                                   "Dutch speaking.French speaking") %>%
                          mutate(across(think_clearly:getting_hurt,
                                        function(x) as.numeric(x))),
                        group = "community",
                        group.equal = c("loadings"))
fit_sameloadingsinterc_atop <- cfa(model_atop,
                        data = likert_data_atop %>%
                          filter(community !=
                                   "Dutch speaking.French speaking") %>%
                          mutate(across(think_clearly:getting_hurt,
                                        function(x) as.numeric(x))),
                        group = "community",
                        group.equal = c("loadings", "intercepts"))

anov_atop_metric <- anova(fit_free_atop, fit_sameloadings_atop) #metric model cannot be rejected
anov_atop_strong <- anova(fit_free_atop, fit_sameloadingsinterc_atop)
#interpret the fit:
interpret(fit_sameloadings_atop)
#TLI need to be >0.95
#A non-significant p-value indicates that the model fits the data well.
# As the chi-square statistic is proportional to the number of observations
#(n), the test will become significant if the sample size is large, even if
#there is only a small discrepancy between S and the fitted matrix implied
#Σ .

cr_omega_atop <- compRelSEM(fit_sameloadings_atop, tau.eq = F, obs.var = T)
cr_alpha_atop <- compRelSEM(fit_sameloadings_atop, tau.eq = T, obs.var = T)
```

@beyer2015development prescribes that the ATOP scale for children has two sub-scales: ATOP-benefits and ATOP-fears (see Table \@ref(tab:atop-translation-kids) in the appendix). We apply multi-group confirmatory factor analysis (CFA) and we hypothesize that the `r length(unique(atop_data$question_code))` items can be explained by these two common factors. 
As described in the methodology, we apply a grouping based on the language of the survey (French of Dutch).

Correlated error terms for two pairs of items were added to the model of @beyer2015development to improve the fit: between the statements *calm_down* and *learn_new_things* and between *calm_down* and *feeling_free*.
We hypothesize that calming down and feeling free are two similar emotions and, in contrast, learning new things typically requires you to be alert in stead of calm.
Table \@ref(tab:atop-loadings) and \@ref(tab:atop-loadings2)  in the appendix show the raw and standardized model estimates.

Table \@ref(tab:atop-cfa-fit) shows the fit for the configural model, a model that assumes metric measurement invariance (equal loadings across the groups), and a model that assumes strong measurement invariance (equal loadings and intercepts across groups).
Measurement invariance analysis showed that a model that assumes metric measurement invariance cannot be rejected using a Chi-Squared Difference Test ($\chi^2$ = `r round(anov_atop_metric[2,"Chisq diff"], 3)`, $\mathrm{df} =$ `r round(anov_atop_metric[2,"Df diff"])`, $p=$ `r round(anov_atop_metric[2,"Pr(>Chisq)"], 3)`) while a model that assumes strong measurement invariance is rejected using a Chi-Squared Difference Test ($\chi^2$ = `r round(anov_atop_strong[2,"Chisq diff"], 3)`, $\mathrm{df} =$ `r round(anov_atop_strong[2,"Df diff"])`, $p=$ `r round(anov_atop_strong[2,"Pr(>Chisq)"], 3)`).
We therefore select the model with metric measurement invariance as the preferred model and all fit measures, except the Chi-square test, indicate good fit (according to @byrne1994structural).

The composite reliability ($\omega$) for this model is `r round(cr_omega_atop$ATOP_benefits[1], 3)` and `r round(cr_omega_atop$ATOP_benefits[2], 3)` for ATOP_benefits for the French and Dutch version respectively. 
The composite reliability is `r round(cr_omega_atop$ATOP_fears[1], 3)` and `r round(cr_omega_atop$ATOP_fears[2], 3)` for ATOP_fears for the French and Dutch version respectively.
The Cronbach Alpha for this model is `r round(cr_alpha_atop$ATOP_benefits[1], 3)` and `r round(cr_alpha_atop$ATOP_benefits[2], 3)` for ATOP_benefits for the French and Dutch version respectively
Cronbach Alpha is `r round(cr_alpha_atop$ATOP_fears[1], 3)` and `r round(cr_alpha_atop$ATOP_fears[2], 3)` for ATOP_fears for the French and Dutch version respectively.
We therefore need to conclude that the internal consistency is barely acceptable. It is better for ATOP_benefits than for ATOP_fears (perhaps due to the fact the one statement was left out of the original set of scale questions) and the French translation work slightly better than the Dutch translation according to McDonald's $\omega$. 


<!-- ???ASSESS Convergent Validity, internal consistency and Discriminant Validity??? -->

```{r atop-cfa-fit}
tab <- fitmeasures(fit_free_atop, c("chisq", "df", "pvalue", "cfi", "tli", "rmsea",
                             "srmr", "AIC", "BIC")) %>%
  as.data.frame() %>%
  cbind(fitmeasures(fit_sameloadings_atop, c("chisq", "df", "pvalue", "cfi",
                                              "tli", "rmsea", "srmr", "AIC",
                                              "BIC")) %>%
          as.data.frame()) %>%
  cbind(fitmeasures(fit_sameloadingsinterc_atop,
                    c("chisq", "df", "pvalue", "cfi", "tli", "rmsea", "srmr",
                      "AIC", "BIC")) %>%
          as.data.frame())


colnames(tab) <- c("configural", "metric", "strong")
avoid_scientif_notation <- function(x){as.character(signif(x, 4))}
tab %>%
  dplyr::mutate_if(is.numeric, avoid_scientif_notation) %>%
  kable(booktabs = TRUE,
        col.names = c("configural", "metric", "strong"),
        caption = "Fit measures for the three ATOP models.") %>%
  kableExtra::kable_styling()
```




\clearpage

### Nature connectedness in kids

```{r read_nc, message=FALSE, warning=FALSE, include=FALSE}
# a description of how to view and read the data from the data package
nc_data <- read_resource(package = baseball_package,
              resource_name = "wp5_nc_data")
nc_key <- read_resource(package = baseball_package,
              resource_name = "wp5_nc_key")
#inspect the description
get_schema(package = baseball_package,
           resource_name = "wp5_nc_data")$fields %>%
  bind_rows() %>%
  kable(booktabs = TRUE) %>%
  kableExtra::kable_styling()
```

Among the `r nrow(children)` children that were selected for the study, `r length(unique(nc_data$child_id))` children filled in the Nature connectedness (NC) questions. Table \@ref(tab:nc-descriptives) shows the descriptive statistics for NC scale items in all children. While the original article suggested to use a 7-point likert scale, a 5-point likert scale was used for brevity. 

In preliminary tests of the survey with a few children, some questions were not clear enough. They were then clarified with some more detail between brackets (see Table \@ref(tab:nc-translation) in the appendix)

Figure \@ref(fig:nc-descriptives2) in the appendix shows the descriptive statistics for Dutch-speaking and French-speaking children separately (children in bilingual schools are included in both). The results are quite similar, though Dutch-speaking children were more outspoken (they tend to choose the "I don't know" option less). Dutch-speaking children also agree more with the statement that nature is very beautiful and less with the statement on feeling part of nature.

```{r nc-descriptives, message=FALSE, warning=FALSE, include=TRUE, echo = FALSE}
nb <- length(unique(nc_data$child_id))
tbl <- nc_data %>%
  group_by(question_short, interpretation) %>%
  summarize(n = n()) %>%
  ungroup() %>%
  mutate(summ = sprintf("%.0f (%.0f%%)", n, n / nb*100)) %>%
  left_join(nc_key %>% dplyr::select(question_short, question_text_english)) %>%
  dplyr::select(-n, -question_short) %>%
  pivot_wider(names_from = interpretation,
              values_from = summ)  %>% 
  mutate_at(2:6, ~replace_na(.,"")) %>%
  dplyr::select(question_text_english, Disagree, `Slightly disagree`,
                `Don't know`, `Moderately agree`, Agree, `No response`)
tbl[order(match(tbl$question_text_english, nc_key$question_text_english)),] %>%
  kable(booktabs = TRUE,
        caption = "Descriptive statistics for Nature Connectedness
        scale items in children.",
        col.names = c("Item", "Disagree", "Slightly disagree", "Don't know",
                     "Moderately agree", "Agree", "No response")) %>%
  kableExtra::kable_styling(font_size = 9) %>%
  kableExtra::column_spec(1, width = "2in") %>%
  kableExtra::column_spec(2:6, width = "0.6in")
```

```{r nc-fit-model, message=FALSE, warning=FALSE, include = FALSE}
#reshape the data for cfa
likert_data_nc <- nc_data %>%
  as.data.frame() %>%
  mutate(interpretation = ifelse(interpretation == "No response",
                                 NA, interpretation),
         interpretation = factor(as.factor(interpretation),
                                 levels = c("Disagree", "Slightly disagree",
                                            "Don\'t know",
                                            "Moderately agree", "Agree"),
                                 ordered = TRUE)) %>%
  dplyr::select(question_short, interpretation, child_id) %>%
  mutate(interpretation = as.numeric(interpretation)) %>%
  group_by(child_id, question_short) %>%
  summarize(interpretation = mean(interpretation, na.rm = TRUE)) %>%
  ungroup() %>%
  pivot_wider(names_from = question_short, values_from = interpretation,
              id_cols = child_id) %>%
  left_join(children) %>%
  left_join(schools) 
model_nc <- "NC =~ 1*beauty + respect + happy + spending_time + enjoy + part_of
  beauty ~~ respect"
fit_free_nc <- cfa(model_nc,
                 data = likert_data_nc %>%
                   filter(community != "Dutch speaking.French speaking"),
                 group = "community")
fit_sameloadings_nc <- cfa(model_nc,
                        data = likert_data_nc %>%
                          filter(community !=
                                   "Dutch speaking.French speaking"),
                        group = "community",
                        group.equal = c("loadings"))
fit_sameloadingsinterc_nc <- cfa(model_nc,
                        data = likert_data_nc %>%
                          filter(community !=
                                   "Dutch speaking.French speaking"),
                        group = "community",
                        group.equal = c("loadings", "intercepts"))

anov_nc_metric <- anova(fit_free_nc, fit_sameloadings_nc) #metric model cannot be rejected
anov_nc_strong <- anova(fit_free_nc, fit_sameloadingsinterc_nc)
#interpret the fit:
interpret(fit_sameloadings_nc)
#TLI need to be >0.95
#A non-significant p-value indicates that the model fits the data well.
# As the chi-square statistic is proportional to the number of observations
#(n), the test will become significant if the sample size is large, even if
#there is only a small discrepancy between S and the fitted matrix implied
#Σ .

cr_omega_nc <- compRelSEM(fit_sameloadings_nc, tau.eq = F, obs.var = T)
cr_alpha_nc <- compRelSEM(fit_sameloadings_nc, tau.eq = T, obs.var = T)
```

In total, `r nrow(likert_data_nc)` out of the `r nrow(children)` children filled in all of the Nature Connectedness questions and can therefore be analyzed further.
We apply multi-group confirmatory factor analysis (CFA) and we hypothesize that the `r length(unique(nc_data$question_code))` items can be explained by one common factor (Nature Connectedness (NC)).
Correlated error terms were included between one pair of statements to improve fit: "I always find nature very beautiful" and "I always treat nature with respect".
These two statements, in contrast to the other four, do not pertain to how nature makes the child feel but to the opinion of the child on nature itself.
The language of the survey was chosen as the grouping for the multi-group CFA.
Table \@ref(tab:nc-loadings) and \@ref(tab:nc-loadings2) in the appendix show the raw and standardized model estimates.


Table \@ref(tab:nc-cfa-fit) shows the fit for the configural model, a model that assumes metric measurement invariance (equal loadings across the groups), and a model that assumes strong measurement invariance (equal loadings and intercepts across groups).
Measurement invariance analysis showed that a model that assumes metric measurement invariance cannot be rejected using a Chi-Squared Difference Test ($\chi^2$ = `r round(anov_nc_metric[2,"Chisq diff"], 3)`, $\mathrm{df} =$ `r round(anov_nc_metric[2,"Df diff"])`, $p=$ `r round(anov_nc_metric[2,"Pr(>Chisq)"], 3)`) while a model that assumes strong measurement invariance is rejected using a Chi-Squared Difference Test ($\chi^2$ = `r round(anov_nc_strong[2,"Chisq diff"], 3)`, $\mathrm{df} =$ `r round(anov_nc_strong[2,"Df diff"])`, $p=$ `r round(anov_nc_strong[2,"Pr(>Chisq)"], 3)`).
We therefore select the model with metric measurement invariance as the preferred model and all fit measures indicate good fit (according to @byrne1994structural, see Table \@ref(tab:nc-cfa-fit)).

The composite reliability ($\omega$) for this model is `r round(cr_omega_nc[2, 2], 3)` and `r round(cr_omega_nc[1, 2], 3)` for the French and Dutch version respectively. For the original English scale, a Cronbach Alpha of 0.899 was reported in children [@hunt2017monitor]. For comparison, our model attains a Cronbach Alpha of `r round(cr_alpha_nc[2, 2], 3)` and `r round(cr_alpha_nc[1, 2], 3)` for the French and Dutch version respectively. This is slightly worse but still indicates sufficiently good reliability.


<!-- ???ASSESS Convergent Validity, internal consistency and Discriminant Validity??? -->

```{r nc-cfa-fit}
tab <- fitmeasures(fit_free_nc, c("chisq", "df", "pvalue", "cfi", "tli", "rmsea",
                             "srmr", "AIC", "BIC")) %>%
  as.data.frame() %>%
  cbind(fitmeasures(fit_sameloadings_nc, c("chisq", "df", "pvalue", "cfi",
                                              "tli", "rmsea", "srmr", "AIC",
                                              "BIC")) %>%
          as.data.frame()) %>%
  cbind(fitmeasures(fit_sameloadingsinterc_nc,
                    c("chisq", "df", "pvalue", "cfi", "tli", "rmsea", "srmr",
                      "AIC", "BIC")) %>%
          as.data.frame())


colnames(tab) <- c("configural", "metric", "strong")
avoid_scientif_notation <- function(x){as.character(signif(x, 3))}
tab %>%
  dplyr::mutate_if(is.numeric, avoid_scientif_notation) %>%
  kable(booktabs = TRUE,
        col.names = c("configural", "metric", "strong"),
        caption = "Fit measures for the three NC models.") %>%
  kableExtra::kable_styling()
```


\clearpage

### Risk engagement and protection survey in parents and guardians

```{r read_reps, message=FALSE, warning=FALSE, include=FALSE}
# a description of how to view and read the data from the data package
reps_data1 <- read_resource(package = baseball_package,
                            resource_name =
                              "wp5_parents_risk_protection_data_part1") %>%
  mutate(response = factor(as.factor(response),
                           levels = c("Strongly disagree", "Disagree",
                                      "Slightly disagree",
                                      "Neigher agree nor disagree",
                                      "Slightly agree", "Agree",
                                      "Strongly agree")))
  
reps_data2 <- read_resource(package = baseball_package,
              resource_name = "wp5_parents_risk_protection_data_part2") %>%
  mutate(response = factor(as.factor(response),
                           levels = c("Never", "Seldom", "Occassionally",
                                     "Sometimes", "Regularly", "Often",
                                     "Always")))
reps_data <- reps_data1 %>%
  mutate(response = as.numeric(response)) %>%
  rbind(reps_data2 %>%
          mutate(response = as.numeric(response)))
nb_parents_reps <- length(
  unique(c(
    str_c(reps_data1$child_id, reps_data1$replicate_id),
    str_c(reps_data2$child_id, reps_data2$replicate_id))))
nb_children_reps <- length(
  unique(c(reps_data1$child_id, reps_data2$child_id, reps_data2$replicate_id)))
reps_key <- cbind(reps_key, factor = c("protection_from_injury", "engagement_with_risk", "protection_from_injury", "engagement_with_risk", "protection_from_injury", "engagement_with_risk", "protection_from_injury", "engagement_with_risk", "protection_from_injury", "engagement_with_risk", "protection_from_injury", "engagement_with_risk", "rain", "wash_hands", "protection_from_injury","protection_from_injury"))
```


The Risk Engagement and Protection Survey was based on @olsen2018risk. This scale was also supplemented by two additional questions:

* "How often do you allow your child to play outside when it is raining?", which was based on a question in @jelleyman2019cross.
* "Should your child wash his/her hands after outdoor play?", which was added since washing hands often might influence the effect of outdoor play on the microbiome.

Figure \@ref(fig:reps-descriptives2) in the appendix shows that Dutch and French-speaking parents seem to answer slightly different. Dutch-speaking parents answered more positive, on average, on the "risk engagement" statements (statement 1 to 6 in Figure \@ref(fig:reps-descriptives2)) and more negative on the "protection from injury" statements (statement 7 to 14 in Figure \@ref(fig:reps-descriptives2)). 

Since there are a lot of statements (14 from REPS and 2 additional ones), these questions were removed from the shortened questionnaire to improve overall response rate for the most important questions for the B@seball project's goals. Therefore, there are only `r nb_parents_reps` parents of `r nb_children_reps` children who filled in all REPS statements (for some children, more than one parent answered the survey).  All statements were answered on a 7-point likert scale. Some questions were coded from "Strongly disagree" to "Strongly agree" while others were coded from "Never" to "Always".

For REPS, it is hypothesized that there are two underlying factors: "Protection from injury" and "Engagement with risk" [@olsen2018risk]. We will test in exploratory factor analysis whether the two additional statements about playing in the rain and washing hands can improve the REPS scale.


```{r reps-descriptives, message=FALSE, warning=FALSE, include=TRUE, echo = FALSE}
nb <- length(unique(reps_data$child_id))
reps_data %>%
  full_join(expand_grid(
    child_id = unique(reps_data$child_id),
    question_short = unique(reps_data$question_short))) %>%
  group_by(question_short, response) %>%
  summarize(n = n()) %>%
  ungroup() %>%
  mutate(summ = sprintf("%.0f (%.0f%%)", n, n/nb*100)) %>%
  left_join(reps_key %>% dplyr::select(question_short, question_text_english)) %>%
  dplyr::select(-n, -question_short) %>%
  pivot_wider(names_from = response,
              values_from = summ) %>% 
  mutate_at(2:8, ~replace_na(.,"")) %>%
  kable(booktabs = TRUE,
        caption = "Descriptive statistics for REPS in parents.",
        col.names = c("Original statement", as.character(1:7),
                      "Not answered")) %>%
  kableExtra::kable_styling(font_size = 8) %>%
  kableExtra::column_spec(1, width = "1.6in") %>%
  kableExtra::column_spec(2:9, width = "0.45in")
```

```{r  message=FALSE, warning=FALSE, include=TRUE, echo = FALSE, fig.width = 6.5, fig.height = 6.5, eval = TRUE}
#------------------------Prepare REPS data for cfa-----------------------------#
#there are no parents who filled it in more than once 
answer_more_than_once <- reps_data %>%
  group_by(child_id, replicate_id, question_short) %>%
  summarise(n = dplyr::n(), .groups = "drop") %>%
  dplyr::filter(n > 1L)
#reshape the data into the proper format
data_cfa_reps <- reps_data %>%
  full_join(expand_grid(#add a row for the missing "wash hands" data
    child_id = unique(reps_data$child_id),
    question_short = unique(reps_data$question_short))) %>%
    dplyr::select(child_id, replicate_id, question_short, response) %>%
  pivot_wider(id_cols = c(child_id, replicate_id), names_from = question_short,
               values_from = response) %>%
   dplyr::select(child_id, replicate_id, reps_key$question_short)
data_cfa_reps_unscaled <- data_cfa_reps
data_cfa_reps[, -c(1, 2)] <- scale(data_cfa_reps[, -c(1, 2)],
                                   center = TRUE, scale = FALSE)
```



```{r message=FALSE, warning=FALSE, include=FALSE, echo = FALSE, eval = TRUE}
#-------------1. Analysing only complete data (no missing answers)-------------#
df <- data_cfa_reps[complete.cases(data_cfa_reps[, -c(1, 2)]), -c(1, 2)]
pca <- prcomp(df)
scree1 <- screeplot(pca, type = "lines")#2 factors is best
covmat <- cov(data_cfa_reps[complete.cases(data_cfa_reps), -c(1, 2)])
cormat <- cor(data_cfa_reps[complete.cases(data_cfa_reps), -c(1, 2)])
efa_complete <- fa(cormat,
                   covar = FALSE,
                   2, rotate = "oblimin",
                   fm = "ml", n.obs = nrow(df))
tables_efa_complete <- fa_table(efa_complete,
                         title = "Factor analysis results with oblique rotation
                         and two factors.",
                         varlabels = str_wrap(reps_key$question_text_english,
                                              15))
tables_efa_complete$ind_table
#the two additional statements do not fit in either of the factors.
#the EFA further uncovers the original two factors although the statement "I encourage my child to do physical activity" is now part of the engagement with risk factor in stead of the protection factor.

#--------------------------------2. EFA with MI--------------------------------#
library(mifa)
mi <- mifa(data = data_cfa_reps[,-c(1, 2)])
fit <- fa(mi$cov_combined, n.obs = nrow(data_cfa_reps), nfactors = 2)
fa.diagram(fit)
tables_atop <- fa_table(fit,
                         title = "Factor analysis results with oblique rotation
                         and two factors.",
                         varlabels = str_wrap(reps_key$question_text_english,
                                              15))
tables_atop$ind_table
#Again, the washing hands and playing in the rain statements don't fit with
# either factor. "I encourage my child to do physical activity (with the least 
# risk of injury)." also does not fit well with either.
```

Due to a mistake, the question on washing hands ("Should your child wash his/her hands after outdoor play?) was not included in the French survey (last column and row in Table \@ref(tab:reps-descriptives)).
We therefore test in two separate exploratory factor analyses (EFA) whether the two additional statements about playing in the rain and washing hands can improve the REPS scale.
Firstly, we apply EFA using only the data of parents who filled in all REPS questions and the two additional statements on washing hands and playing in the rain (`r nrow(df)` parents).
Secondly, we use the *mifa* package to execute an exploratory factor analysis with multiple imputation in which case we can use the data of `r nrow(mi$mids$data)` parents.
Both of these analyses show that the statements on playing in the rain or washing hands do not fit well with the REPS factors and are therefore ignored in the CFA that follows (see section \@ref(repsefa) in the appendix). Additionally, the EFA with oblique rotation confirms that there are two factors in the data (one for protection from injury and one for risk engagement), as we expected.

Multigroup CFA was performed  with a grouping based on the language of the survey. 

```{r reps-fit-model, message=FALSE, warning=FALSE, include = FALSE}
reps_data1 <- read_resource(package = baseball_package,
                            resource_name =
                              "wp5_parents_risk_protection_data_part1") %>%
  mutate(response = factor(as.factor(response),
                           levels = c("Strongly disagree", "Disagree",
                                      "Slightly disagree",
                                      "Neigher agree nor disagree",
                                      "Slightly agree", "Agree",
                                      "Strongly agree")))

reps_data2 <- read_resource(package = baseball_package,
                            resource_name = "wp5_parents_risk_protection_data_part2") %>%
  mutate(response = factor(as.factor(response),
                           levels = c("Never", "Seldom", "Occassionally",
                                      "Sometimes", "Regularly", "Often",
                                      "Always")))
reps_data <- reps_data1 %>%
  mutate(response = as.numeric(response)) %>%
  rbind(reps_data2 %>%
          mutate(response = as.numeric(response)))
likert_data_reps <- reps_data %>%
  as.data.frame() %>%
  mutate(interpretation = response) %>%
  rbind(c("10-5X-03", "1", "Single response", "wash_hands", "x6_14", NA,
          NA)) %>% #this line is missing from the data
  dplyr::select(question_short, interpretation, child_id) %>%
  mutate(interpretation = as.numeric(interpretation)) %>%#for some reason, this is changed to character
  dplyr::group_by(child_id, question_short) %>% #There are children whose parents filled it in more than once
  dplyr::summarise(interpretation = mean(interpretation, na.rm = TRUE),
                   .groups = "drop") %>%
  pivot_wider(names_from = question_short, values_from = interpretation,
              id_cols = child_id) %>%
  left_join(children) %>%
  left_join(schools)

reps_key <- read_resource(package = baseball_package,
                          resource_name = "wp5_parents_risk_protection_key")
reps_key <- cbind(reps_key, factor = c("protection_from_injury", "engagement_with_risk", "protection_from_injury", "engagement_with_risk", "protection_from_injury", "engagement_with_risk", "protection_from_injury", "engagement_with_risk", "protection_from_injury", "engagement_with_risk", "protection_from_injury", "engagement_with_risk", "rain", "wash_hands", "protection_from_injury","protection_from_injury"))

model_reps <- "protection_from_injury =~ 1*prevention_importance + concerned_injury + concerned_hazards + avoid_risk + importance_supervision + chance_of_injury + limit_dangerous_activities + encourage_safe_activities
          risk_engagement =~ 1*promote_physical_challenges + physical_limits + explore_new_environments + benefits_outweigh_risk + importance_managing_risk + risk_self_confidence"
           # prevention_importance ~~  chance_of_injury
           # concerned_injury ~~ concerned_hazards
           # concerned_hazards ~~ avoid_risk
           # prevention_importance ~~ avoid_risk
fit_free_reps <- cfa(model_reps,
                 data = likert_data_reps %>%
                   filter(community != "Dutch speaking.French speaking"),
                 group = "community")
fit_sameloadings_reps <- cfa(model_reps,
                        data = likert_data_reps %>%
                          filter(community !=
                                   "Dutch speaking.French speaking"),
                        group = "community",
                        group.equal = c("loadings"))
fit_sameloadingsinterc_reps <- cfa(model_reps,
                        data = likert_data_reps %>%
                          filter(community !=
                                   "Dutch speaking.French speaking"),
                        group = "community",
                        group.equal = c("loadings", "intercepts"))

anov_reps_metric <- anova(fit_free_reps, fit_sameloadings_reps) #metric model cannot be rejected
anov_reps_strong <- anova(fit_free_reps, fit_sameloadingsinterc_reps)
#interpret the fit:
interpret(fit_sameloadings_reps) #they all show poor fit
#TLI need to be >0.95
#A non-significant p-value indicates that the model fits the data well.
# As the chi-square statistic is proportional to the number of observations
#(n), the test will become significant if the sample size is large, even if
#there is only a small discrepancy between S and the fitted matrix implied
#Σ .


cr_omega_reps <- compRelSEM(fit_sameloadings_reps, tau.eq = F, obs.var = T)
cr_alpha_reps <- compRelSEM(fit_sameloadings_reps, tau.eq = T, obs.var = T)
```


Table \@ref(tab:reps-loadings) to \@ref(tab:reps-loadings4) in the appendix show the raw and standardized coefficient estimates.
Table \@ref(tab:reps-cfa-fit) shows the fit for the configural model, a model that assumes metric measurement invariance (equal loadings across the groups), and a model that assumes strong measurement invariance (equal loadings and intercepts across groups).
Measurement invariance analysis showed that a model that assumes metric measurement invariance can be rejected using a Chi-Squared Difference Test ($\chi^2$ = `r round(anov_reps_metric[2,"Chisq diff"], 3)`, $\mathrm{df} =$ `r round(anov_reps_metric[2,"Df diff"])`, $p=$ `r round(anov_reps_metric[2,"Pr(>Chisq)"], 3)`) a model that assumes strong measurement invariance is also rejected using a Chi-Squared Difference Test ($\chi^2$ = `r round(anov_reps_strong[2,"Chisq diff"], 3)`, $\mathrm{df} =$ `r round(anov_reps_strong[2,"Df diff"])`, $p=$ `r round(anov_reps_strong[2,"Pr(>Chisq)"], 3)`).
We therefore select the model with configural measurement invariance as the preferred model. However, all fit measures indicate poor fit (according to @byrne1994structural).

The composite reliability ($\omega$) for this model is `r round(cr_omega_reps$protection_from_injury[2], 3)` and `r round(cr_omega_reps$protection_from_injury[1], 3)` for "protection from injury" for the French and Dutch version respectively. 
The composite reliability is `r round(cr_omega_reps$risk_engagement[2], 3)` and `r round(cr_omega_reps$risk_engagement[1], 3)` for "risk engagement" for the French and Dutch version respectively.
We therefore need to conclude that the internal consistency is not acceptable, especially for the French translation of the "protection from injury" factor.
Cronbach $\alpha$ values indicate a reasonable fit for the Dutch translation (`r round(cr_alpha_reps$protection_from_injury[1], 3)` for protection from injury and `r round(cr_alpha_reps$risk_engagement[1], 3)` for risk engagement).
But the French translation is still not up to par (`r round(cr_alpha_reps$protection_from_injury[2], 3)` for protection from injury and `r round(cr_alpha_reps$risk_engagement[2], 3)` for risk engagement).



<!-- ???ASSESS Convergent Validity, internal consistency and Discriminant Validity??? -->

```{r reps-cfa-fit}
tab <- fitmeasures(fit_free_reps, c("chisq", "df", "pvalue", "cfi", "tli", "rmsea",
                             "srmr", "AIC", "BIC")) %>%
  as.data.frame() %>%
  cbind(fitmeasures(fit_sameloadings_reps, c("chisq", "df", "pvalue", "cfi",
                                              "tli", "rmsea", "srmr", "AIC",
                                              "BIC")) %>%
          as.data.frame()) %>%
  cbind(fitmeasures(fit_sameloadingsinterc_reps,
                    c("chisq", "df", "pvalue", "cfi", "tli", "rmsea", "srmr",
                      "AIC", "BIC")) %>%
          as.data.frame())


colnames(tab) <- c("configural", "metric", "strong")
avoid_scientif_notation <- function(x){as.character(signif(x, 4))}
tab %>%
  dplyr::mutate_if(is.numeric, avoid_scientif_notation) %>%
  kable(booktabs = TRUE,
        col.names = c("configural", "metric", "strong"),
        caption = "Fit measures for the three REPS models.") %>%
  kableExtra::kable_styling()
```


\clearpage

### Validity analysis

The validity of the ATOP, NC and REPS scales was examined through testing associations between the scales and related variables.
In Section \@ref(outdoor-play), we look at related questions on outdoor and indoor activities in which the child participates.
These questions are inspired by @beyer2015development
In Section \@ref(independent-mobility), we look at related questions on the independent mobility of the child, based on @shaw2013children.


```{r calc-factor-scores}
full_atop_scores <- likert_data_atop %>%
  filter(community != "Dutch speaking.French speaking") %>%
  dplyr::select(child_id, community, think_clearly:getting_hurt) %>%
  na.omit() %>%
  arrange(community)#first all dutch, then french
scores_atop <- lavPredict(fit_sameloadings_atop,
                          newdata = full_atop_scores)
full_atop_scores <- full_atop_scores %>%
  mutate(ATOP_benefits = c(scores_atop$`Dutch speaking`[, 1],
                           scores_atop$`French speaking`[, 1]),
         ATOP_fears = c(scores_atop$`Dutch speaking`[, 2],
                           scores_atop$`French speaking`[, 2]),
         )

full_nc_scores <- likert_data_nc %>%
  filter(community != "Dutch speaking.French speaking") %>%
  dplyr::select(child_id, community, beauty:spending_time) %>%
  na.omit() %>%
  arrange(community)#first all dutch, then french
scores_nc <- lavPredict(fit_sameloadings_nc,
                          newdata = full_nc_scores)
full_nc_scores <- full_nc_scores %>%
  mutate(NC = c(scores_nc$`Dutch speaking`[, 1],
                           scores_nc$`French speaking`[, 1])
         )


full_reps_scores <- likert_data_reps %>%
  filter(community != "Dutch speaking.French speaking") %>%
  dplyr::select(child_id, community, avoid_risk:risk_self_confidence) %>%
  dplyr::select(-play_in_rain) %>%
  na.omit() %>%
  arrange(community)#first all dutch, then french
scores_reps <- lavPredict(fit_free_reps,
                          newdata = full_reps_scores)
full_reps_scores <- full_reps_scores %>%
  mutate(REPS_protection_from_injury = c(scores_reps$`Dutch speaking`[, 1],
                           scores_reps$`French speaking`[, 1]),
         REPS_risk_engagement = c(scores_reps$`Dutch speaking`[, 2],
                           scores_reps$`French speaking`[, 2]),
         )


```

#### Outdoor play

```{r read_atop_p, message=FALSE, warning=FALSE, include=FALSE}
atop_data_p1 <- read_resource(package = baseball_package,
              resource_name = "wp5_parents_outdoor_play_data_part1")
atop_data_p2 <- read_resource(package = baseball_package,
              resource_name = "wp5_parents_outdoor_play_data_part2")
atop_data_p3 <- read_resource(package = baseball_package,
              resource_name = "wp5_parents_outdoor_play_data_part3")
atop_data_p4 <- read_resource(package = baseball_package,
              resource_name = "wp5_parents_outdoor_play_data_part4")
atop_key_p <- read_resource(package = baseball_package,
              resource_name = "wp5_parents_outdoor_play_key")
```

The parents were asked about how often their children play and what type of activities (both indoor and outdoor) they typically engage in.
Since the response rate was disappointing at first, some questions were left out in a shortened version of the questionnaire to hopefully motivate parents to fill it in (see also Table \@ref(tab:atop-translation) in the appendix).

Table \@ref(tab:atop-p-descriptives) shows the descriptives for each of the questions. Figures \@ref(fig:opp1) to \@ref(fig:opp3) in the appendix show the same data visually for both languages separately.


```{r atop-p-descriptives, message=FALSE, warning=FALSE, include=TRUE, echo = FALSE}
nb <- length(unique(c(atop_data_p1$child_id, atop_data_p2$child_id,
                      atop_data_p2$child_id, atop_data_p4$child_id)))
tbl1 <- atop_data_p1 %>%
  group_by(question_short) %>%
  summarize(unit = str_remove(unique(unit), "number of "),
            s = sprintf("mean %.2f, (sd %.2f) %s", mean(response), sd(response), unit),
            n = n_distinct(child_id)) %>%
  ungroup() %>%
  dplyr::select(-unit, -n)
tbl2 <- atop_data_p2 %>%
  mutate(response = ifelse(response == "association", "yes",
                           ifelse(response == "no association",
                                  "no",
                                  "maybe"))) %>%
  group_by(question_short, response) %>%
  summarize(n = n_distinct(child_id)) %>%
  mutate(s = sprintf("%s: %d", response, n)) %>%
  arrange(question_short, desc(s)) %>%
  summarize(s = str_c(s, collapse = ", ")) %>%
  dplyr::filter(question_short != "other_outdoor_play")
tbl3 <- atop_data_p3 %>%
  dplyr::filter(str_length(response) < 5) %>% #only keep cases with 1 response or where both responses agree
  mutate(response = factor(as.factor(response),
                           levels = c("0", "< 1", "1-2", "2-3", "3-4", "> 4"))
         ) %>%
  group_by(question_short, unit, response) %>%
  summarize(n = n_distinct(child_id)) %>%
  mutate(s = sprintf("%s: %d", response, n)) %>%
  arrange(question_short, response) %>%
  summarize(s = str_c(s, collapse = ", ")) %>%
  mutate(s = str_c(unit, ":", s)) %>%
  dplyr::select(-unit) %>%
  ungroup()
tbl4 <- atop_data_p4 %>%
  dplyr::filter(!str_detect(response, "-")) %>% #only keep cases with 1 response or where both responses agree
  group_by(question_short, response) %>%
  summarize(n = n_distinct(child_id)) %>%
  mutate(s = sprintf("%s: %d", response, n)) %>%
  arrange(question_short, response) %>%
  summarize(s = str_c(s, collapse = ", "))

tbl1 %>%
  rbind(tbl2) %>%
  rbind(tbl3) %>%
  rbind(tbl4) %>%
  left_join(atop_key_p %>%
              dplyr::select(question_short, question_text_english)) %>%
  mutate(question_text_english =
           ifelse(startsWith(question_text_english, "How often"),
                             str_split_i(question_text_english,
                                         pattern = "/", i = 2),
                  question_text_english)) %>%
  dplyr::select(question_text_english, s) %>%
  kable(booktabs = TRUE, longtable = TRUE, 
        caption = "Descriptive statistics for outdoor play activities
        according to the parents.",
        col.names = c("Question", "Summary")) %>%
  kableExtra::kable_styling(latex_options = c("repeat_header"),
                            font_size = 9) %>%
  kableExtra::column_spec(1, width = "3in") %>%
  kableExtra::column_spec(2, width = "3in")
```


These answers can be used to validate the answers that were received from the children with respect to their attitude towards outdoor play. To do so, we first check whether there is a big difference in the children whose parents answered (`r nb` in total of which `r nb-length(unique(atop_data_p4$child_id))` answered the full (not shortened) questionnaire) and the children whose parents did not answer the questionnaire (`r nrow(children) - nb`). Table \@ref(tab:atop-p-response-difference) shows that relatively few Dutch-speaking parents answered the long questionnaire and they were more likely not to respond at all. We can see that the response rate was especially low in the Flemish (Dutch-speaking) provinces of West-Vlaanderen, Vlaams-Brabant, Oost-Vlaanderen, and Antwerp.

The last three rows in Table \@ref(tab:atop-p-response-difference) show that, while there is no statistically significant difference in the factor scores of ATOP_fears, children of parents who filled in the short questionnaire scored significantly higher on ATOP_benefits than those of parents who filled in the long questionnaire.

This means that there may be some selection bias in who filled in the full questionnaire and we will have to be careful when interpreting the results.

```{r atop-p-response-difference, message=FALSE, warning=FALSE, include=TRUE, echo = FALSE}
diff_atop <- children %>%
  left_join(full_atop_scores) %>%
  left_join(full_nc_scores) %>%
  mutate(response = ifelse(child_id %in% atop_data_p2$child_id &
                             !(child_id %in% atop_data_p4$child_id),
                           "long",
                           ifelse(child_id %in% atop_data_p4$child_id,
                                  "short", "none")),
         response = factor(as.factor(response),
                                     levels = c("long", "short", "none"))) %>%
  group_by(response) %>%
  summarize(ATOP_benefits =
              sprintf("%.3f [%.3f, %.3f]",
                      mean(ATOP_benefits, na.rm = T),
                      mean(ATOP_benefits, na.rm = T) -
                        qt(p = 0.025, df = n() - 1, lower.tail = F) *
                        sd(ATOP_benefits, na.rm = T) / sqrt(n()),
                      mean(ATOP_benefits, na.rm = T) +
                        qt(p = 0.025, df = n() - 1, lower.tail = F) *
                        sd(ATOP_benefits, na.rm = T) / sqrt(n())),
            ATOP_fears =
              sprintf("%.3f [%.3f, %.3f]",
                      mean(ATOP_fears, na.rm = T),
                      mean(ATOP_fears, na.rm = T) -
                        qt(p = 0.025, df = n() - 1, lower.tail = F) *
                        sd(ATOP_fears, na.rm = T) / sqrt(n()),
                      mean(ATOP_fears, na.rm = T) +
                        qt(p = 0.025, df = n() - 1, lower.tail = F) *
                        sd(ATOP_fears, na.rm = T) / sqrt(n())),
            NC =
              sprintf("%.3f [%.3f, %.3f]",
                      mean(NC, na.rm = T),
                      mean(NC, na.rm = T) -
                        qt(p = 0.025, df = n() - 1, lower.tail = F) *
                        sd(NC, na.rm = T) / sqrt(n()),
                      mean(NC, na.rm = T) +
                        qt(p = 0.025, df = n() - 1, lower.tail = F) *
                        sd(NC, na.rm = T) / sqrt(n()))) %>%
  pivot_longer(
    cols = !response,
    names_to = "variable",
    values_to = "nb_perc") %>%
  pivot_wider(names_from = response,
              values_from = `nb_perc`)

children %>%
  mutate(response = ifelse(child_id %in% atop_data_p2$child_id &
                             !(child_id %in% atop_data_p4$child_id),
                           "long",
                           ifelse(child_id %in% atop_data_p4$child_id,
                                  "short", "none")),
         response = factor(as.factor(response),
                                     levels = c("long", "short", "none"))) %>%
  group_by(response) %>%
  summarize(Number = n(),
            #age = mean(age_202205),#age is not known if the parents did not fill in the survey
            Dutch = sum(community == "Dutch speaking"),
            French = sum(community == "French speaking"),
            Bilingual = sum(community == "Dutch speaking.French speaking"),
            `West-Vlaanderen` = sum(province_name == "West-Vlaanderen"),
            `Vlaams-Brabant` = sum(province_name == "Vlaams-Brabant"),
            `Oost-Vlaanderen` = sum(province_name == "Oost-Vlaanderen"),
            Antwerpen = sum(province_name == "Antwerpen"),
            Brussels = sum(province_name == "Brussels Capital Region"),
            Hainaut = sum(province_name == "Hainaut"),
            Liege = sum(province_name == "Liège"),
            Namur = sum(province_name == "Namur"),
            Luxembourg = sum(province_name == "Luxembourg")) %>%
  ungroup() %>%
  # mutate(across(Dutch : Luxembourg, ~ sprintf("%d, (%.2f%%)", .x, 100*.x / nb)),
  #        Number = as.character(Number)) %>%
  pivot_longer(
    cols = !response,
    names_to = "variable",
    values_to = "nb_perc") %>%
  pivot_wider(names_from = response,
              values_from = `nb_perc`) %>%
  mutate(rowsum = rowSums(across(where(is.numeric)))) %>%
  mutate(across(long:none, ~ sprintf("%d (%.2f%%)", .x, 100*.x / rowsum))) %>%
  dplyr::select(-rowsum) %>%
  rbind(diff_atop) %>%
  kable(booktabs = TRUE,
        font_size = 9,
        caption = "Demographics for children whose parents filled in the long
        questionnaire, short questionnaire, or no questionnaire.",
        col.names = c("", "Long questionnaire", "Short questionnaire",
                      "No response")) %>%
  kableExtra::kable_styling(font_size = 9) %>%
  kableExtra::group_rows(group_label = "Number of children",
                        start_row = 1, end_row = 1) %>%
  kableExtra::group_rows(group_label = "Community",
                        start_row = 2, end_row = 4) %>%
  kableExtra::group_rows(group_label = "Province",
                        start_row = 5, end_row = 13) %>%
  kableExtra::group_rows(group_label = "ATOP factor scores (mean [.95 CI])",
                        start_row = 14, end_row = 15) %>%
  kableExtra::group_rows(group_label = "NC factor scores (mean [.95 CI])",
                        start_row = 16, end_row = 16)
```


Table \@ref(tab:externalval) shows whether there is an association between the factor scores and the indoor and outdoor activities of the children.
For questions with a binary answer (the first 14 questions), the mean factor score for those who said yes/no is shown, the stars indicate whether there is a statistically significant difference.
For questions with a numeric answer (for instance how many days per week or hours per day an activity is done), the correlation is shown and the stars indicate whether it is significantly different from zero.
Most of the relations are intuitive, except for the ATOP_fears  associations.
For instance, building huts is associated with higher ATOP_benefits, higher nature connectedness, higher REPS_risk_engagement, and lower REPS_protection_from_injury.
However, we would also expect it to be associated with lower ATOP_fears (as in @beyer2015development) however, the opposite is true.
It is also interesting to see that higher ATOP_benefits is associated with a lower amount of screen time while higher REPS_protection_from_injury is associated with a higher amount of screen time.

```{r externalval, message=FALSE, warning=FALSE, include=TRUE, echo = FALSE}
tbl2 <- atop_data_p2 %>%
  mutate(response = ifelse(response == "no association - association",
                           "association", response),
         response = 1*(response == "association")) %>%
  group_by(child_id, question_short) %>%
  summarize(response = first(response)) %>% # keep only one answer per child
  ungroup() %>%
  pivot_wider(id_cols = child_id, names_from = question_short,
              values_from = response) %>%
  left_join(atop_data_p1 %>%
              group_by(child_id, question_short) %>%
              summarize(response = first(response)) %>% # keep only one answer per child
              ungroup() %>%
              pivot_wider(id_cols = child_id, names_from = question_short,
                          values_from = response))  %>%
  left_join(atop_data_p3 %>%
              mutate(
                response =
                  ifelse(str_detect(response, "0"),
                         0,
                         ifelse(response == "< 1",
                                0.5,
                                ifelse(str_detect(response, "1-2"),
                                       1.5,
                                       ifelse(str_detect(response, "2-3"),
                                              2.5,
                                              ifelse(str_detect(response,
                                                                "3-4"),
                                                     3.5, 5)))))) %>%
              group_by(child_id, question_short) %>%
              summarize(response = first(response)) %>% # keep only one answer per child
              ungroup() %>%
              pivot_wider(id_cols = child_id, names_from = question_short,
                          values_from = response)) %>% 
  dplyr::select(-other_outdoor_play) %>%
  left_join(full_atop_scores %>%
              dplyr::select(child_id, starts_with("ATOP"))) %>%
  left_join(full_nc_scores %>%
              dplyr::select(child_id, starts_with("NC"))) %>%
  left_join(full_reps_scores %>%
              dplyr::select(child_id, starts_with("REPS")))
test_diff <- function(x, y){
         test <- t.test(eval(parse(text = y)) ~
                          as.factor(eval(parse(text = colnames(tbl2)[x]))),
                        data = tbl2)
         result <- sprintf("No: %.3f, Yes: %.3f %s",
                           unname(test$estimate[1]),
                           unname(test$estimate[2]),
                           gtools::stars.pval(test$p.value))
         return(result)}
test_diff_cont <- function(x, y){
         correlation <- cor(tbl2[, y],
                     tbl2[, x],
                     use = "complete.obs",
                     method = "pearson")
         pvalue <- cor.test(unlist(tbl2[, y]),
                     unlist(tbl2[, x]),
                     method = "pearson")
         result <- sprintf("correlation: %.3f %s",
                           unname(correlation),
                           gtools::stars.pval(pvalue$p.value))
         return(result)}
t <- data.frame(
  question_short = colnames(tbl2)[2:15],
  ATOP_benefits = mapply(test_diff, 2:15, "ATOP_benefits"),
  ATOP_fears = mapply(test_diff, 2:15, "ATOP_fears"),
  NC = mapply(test_diff, 2:15, "NC"),
  REPS_risk_engagement = mapply(test_diff, 2:15, "REPS_risk_engagement"),
  REPS_protection_from_injury = mapply(test_diff, 2:15,
                                       "REPS_protection_from_injury")
) %>%
  rbind(
    data.frame(
      question_short = colnames(tbl2)[16:23],
      ATOP_benefits = mapply(test_diff_cont, 16:23, "ATOP_benefits"),
      ATOP_fears = mapply(test_diff_cont, 16:23, "ATOP_fears"),
      NC = mapply(test_diff_cont, 16:23, "NC"),
      REPS_risk_engagement = mapply(test_diff_cont, 16:23, "REPS_risk_engagement"),
      REPS_protection_from_injury = mapply(test_diff_cont, 16:23,
                                       "REPS_protection_from_injury"))) %>%
  left_join(atop_key_p %>%
              dplyr::select(question_short, question_text_english)) %>%
  mutate(question_text_english =
           ifelse(startsWith(question_text_english, "How often"),
                             str_split_i(question_text_english,
                                         pattern = "/", i = 2),
                  question_text_english)) %>%
  dplyr::select(-question_short) %>%
  relocate(question_text_english)
t %>%
  kable(booktabs = TRUE, longtable = TRUE,
        caption = "Associations of factor scores with related indoor and outdoor activities.",
        col.names = c("", "ATOP benefits", "ATOP fears", "NC",
                      "REPS risk engagement", "REPS protection from injury")) %>%
  kableExtra::kable_styling(latex_options = c("repeat_header"),
                            font_size = 9) %>%
  kableExtra::column_spec(1, width = "2in") %>%
  kableExtra::column_spec(2, width = "0.7in",
                          bold = str_detect(t[,2], "\\*")) %>%
  kableExtra::column_spec(3, width = "0.7in",
                          bold = str_detect(t[,2], "\\*")) %>%
  kableExtra::column_spec(4, width = "0.7in",
                          bold = str_detect(t[,2], "\\*")) %>%
  kableExtra::column_spec(5, width = "0.7in",
                          bold = str_detect(t[,2], "\\*")) %>%
  kableExtra::column_spec(6, width = "0.7in",
                          bold = str_detect(t[,2], "\\*")) %>%
  kableExtra::add_footnote(
    label = ". p < 0.1, * p <.05, ** p <.01, *** p <.001")

```


\clearpage


#### Independent mobility

Lastly, the parents answered questions on the independent mobility of their child, inspired by @shaw2013children. They question parents on how much freedom they allow their children to travel around their own neighbourhood or city without adult supervision.
This survey on independent mobility was previously executed in England and Germany over the years, starting in 1971.
Researchers concluded that there has been a large reduction in independent mobility for primary school children over the years.
We hypothesize that the independent mobility of a child might be related to the two REPS factors.

To improve response rate, these questions were left out in a shortened version of the survey. 
Therefore, the number of responses is greatly reduced and we cannot be sure that the people who filled in the full survey represent an unbiased sample (Table \@ref(tab:atop-p-response-difference)).
Table \@ref(tab:im-descriptives) shows the descriptives.

Table \@ref(tab:externalval-im) shows whether there is an association between the factor scores and the independent mobility of the children. The mean factor score for those who said yes/no is shown, the stars indicate whether there is a statistically significant difference.
The table shows that indeed, while the ATOP and NC do not show any strong links to independent mobility, the REPS factors do.
Parents with high REPS_risk_engagement tend to allow their child to go out alone after dark, cross main roads on their own, roam their neighborhood alone or with friends, and go to places within walking distance.
Parents with high REPS_protection_from_injury tend to *not* allow their child to cross main road on their own, let their child roam the neighborhood alone or with friends, or go to places within walking distance.  


```{r read_im, message=FALSE, warning=FALSE, include=FALSE}
# a description of how to view and read the data from the data package
im_data <- read_resource(package = baseball_package,
                            resource_name =
                              "wp5_parents_independent_mobility_data") %>%
  mutate(response = factor(as.factor(response),
                           levels = c("No", "Yes - No", "Yes")))
```

```{r im-descriptives, message=FALSE, warning=FALSE, include=TRUE, echo = FALSE}
nb <- length(unique(paste0(im_data$child_id, im_data$replicate_id)))
tbl <- im_data %>%
  group_by(question_short, response) %>%
  summarize(n = n()) %>%
  ungroup() %>%
  mutate(summ = sprintf("%.0f (%.0f%%)", n, n/nb*100)) %>%
  left_join(im_key %>% dplyr::select(question_short, question_text_english)) %>%
  dplyr::select(-n, -question_short) %>%
  pivot_wider(names_from = response,
              values_from = summ)  %>% 
  mutate_at(2:4, ~replace_na(.,"")) %>%
  dplyr::select(question_text_english, No, `Yes - No`, Yes)
tbl[order(match(tbl$question_text_english, im_key$question_text_english)),] %>%
  kable(booktabs = TRUE,
        caption = "Descriptive statistics for Independent Mobility.",
        col.names = c("Item", "No", "Yes - No", "Yes")) %>%
  kableExtra::kable_styling(font_size = 9) %>%
  kableExtra::column_spec(1, width = "2in") %>%
  kableExtra::column_spec(2:4, width = "0.6in")
```

```{r externalval-im, message=FALSE, warning=FALSE, include=TRUE, echo = FALSE}
tbl2 <- im_data %>%
  mutate(response = ifelse(str_detect(response, "Yes"), 1, 0)) %>%
  group_by(child_id, question_short) %>%
  summarize(response = first(response)) %>% # keep only one answer per child
  ungroup() %>%
  pivot_wider(id_cols = child_id, names_from = question_short,
              values_from = response) %>%
  left_join(full_atop_scores %>%
              dplyr::select(child_id, starts_with("ATOP"))) %>%
  left_join(full_nc_scores %>%
              dplyr::select(child_id, starts_with("NC"))) %>%
  left_join(full_reps_scores %>%
              dplyr::select(child_id, starts_with("REPS")))

t <- data.frame(
  question_short = colnames(tbl2)[2:9],
  ATOP_benefits = mapply(test_diff, 2:9, "ATOP_benefits"),
  ATOP_fears = mapply(test_diff, 2:9, "ATOP_fears"),
  NC = mapply(test_diff, 2:9, "NC"),
  REPS_risk_engagement = mapply(test_diff, 2:9, "REPS_risk_engagement"),
  REPS_protection_from_injury = mapply(test_diff, 2:9,
                                       "REPS_protection_from_injury")
  ) %>%
  left_join(im_key %>%
              dplyr::select(question_short, question_text_english)) %>%
  dplyr::select(-question_short) %>%
  relocate(question_text_english)
t %>%
  kable(booktabs = TRUE, longtable = TRUE,
        caption = "Associations of factor scores with independent mobility.",
        col.names = c("", "ATOP benefits", "ATOP fears", "NC",
                      "REPS risk engagement", "REPS protection from injury")) %>%
  kableExtra::kable_styling(latex_options = c("repeat_header"),
                            font_size = 9) %>%
  kableExtra::column_spec(1, width = "2in") %>%
  kableExtra::column_spec(2, width = "0.7in",
                          bold = str_detect(t[,2], "\\*")) %>%
  kableExtra::column_spec(3, width = "0.7in",
                          bold = str_detect(t[,2], "\\*")) %>%
  kableExtra::column_spec(4, width = "0.7in",
                          bold = str_detect(t[,2], "\\*")) %>%
  kableExtra::column_spec(5, width = "0.7in",
                          bold = str_detect(t[,2], "\\*")) %>%
  kableExtra::column_spec(6, width = "0.7in",
                          bold = str_detect(t[,2], "\\*")) %>%
  kableExtra::add_footnote(
    label = ". p < 0.1, * p <.05, ** p <.01, *** p <.001")

```


\clearpage

## Structural equation model (SEM)

To answer our overarching research questions 4, 5, and 6, we will use a structural equation model (SEM) and link the scales to other exogenous variables.

As the translated REPS scale is currently deemed unreliable and the fit was not good,  we will not use it in the SEM. This means that we will not be able to answer research question 4 which aimed to analyse whether there is a connection between the parents' REPS and the children's ATOP. However, leaving REPS out of the model will allow us to work with much more data since the response rate for the REPS questions was very low (around 50%).

We include the ATOP and NC scales with the following additional covariances between some of the statements as specified in section \@ref(scale-questions). Since we want to know how the three latent factors are relate to each other, we include covariances between the three factors. Lastly, we add a regression for each latent factor with the following exogenous variables as covariates:

- the gender of the child.
- the socio-economic status of the child (see section \@ref(socio-economic-status)). We include the child-level SES, if available. Otherwise, we use the school-level SES as a proxy to avoid too much missingness.
- the school context / type of playground as a binary variable (low versus high greenness, see section \@ref(school-environment)).
- the landscape type around the school as a binary variable (low versus high naturalness, see section \@ref(school-environment)).

The B@seball project members also suggested to add air pollution (based on black carbon levels, nitrogen oxide (NOX) levels, and particulate matter) and an interaction between the school and landscape environment. Since the multi-group analysis did not fit well, the language (Dutch versus French) was also tested as a possible covariate. Adding any of these covariates to the regression analyses, however, made the fit worse and did not yield any important additional insights.


```{r fit-sem, warning = FALSE, message = FALSE, include = FALSE}
landscape_data <- read_resource(
  package = baseball_package,
  resource_name = "wp1_landscape_level_data")
sem_data <- likert_data_atop %>%
  mutate(across(think_clearly:getting_hurt,
                function(x) as.numeric(x))) %>%
  left_join(likert_data_nc %>%
              dplyr::select(child_id:spending_time)) %>%
  left_join(child_derived %>%
              dplyr::select(child_id, ses) %>%
              rename(ses_child = ses)) %>%
  dplyr::select(-class_id, -birth_year, -birth_month, -age_202205,
                -province_name, -pm25, -sirm_mean, -starts_with("playground"),
                -starts_with("extra"), -in_school_prop_green,
                -out_school_prop_green, -natural_elements_score,
                -artificial_elements_score, -tree_number, -allergenic_potential,
                -case_control_id) %>%#remove redundant columns
  mutate(sex_male = 1 * (biological_sex == "Male"),
         landscape_type_high_naturalness =
           1 * (landscape_type == "high naturalness"),
         school_context_high_greenness =
           1 * (school_context == "high greenness"),
         interaction =
           as.factor(ifelse(landscape_type == "high naturalness",
                            ifelse(school_context == "high greenness",
                                   "h-h", "h-l"),
                            ifelse(school_context == "high greenness",
                                   "l-h", "l-l")
                     )),
         interaction_h_h = 1 * (interaction == "h-h"),
         interaction_h_l = 1 * (interaction == "h-l"),
         interaction_l_h = 1 * (interaction == "l-h"),
         interaction_l_l = 1 * (interaction == "l-l"),
         ses_child = ifelse(is.na(ses_child), ses, ses_child),
         French = str_detect(community, "French")) %>%
  left_join(
    landscape_data %>%
      select(school_id, c(landscape_type, bc, no2, pm10_min_pm25, pm25))
  )
#define lavaan models
model_sem <- "
  #latent variable definitions
  ATOP_benefits =~ 1*think_clearly + good_for_health + calm_down + learn_new_things +   feeling_free + imagination + explore 
  ATOP_fears =~ 1*get_lost + unknown_persons + wild_animals + getting_hurt
  calm_down ~~ learn_new_things
  calm_down ~~ feeling_free
  NC =~ 1*beauty + respect + happy + spending_time + enjoy + part_of
  beauty ~~ respect
  
  #Add correlations of interest
  ATOP_benefits ~~ NC
  ATOP_fears ~~ NC
  ATOP_benefits ~~ ATOP_fears

  #regressions
  ATOP_benefits ~ sex_male + landscape_type_high_naturalness + school_context_high_greenness + ses_child 
  ATOP_fears ~  sex_male + landscape_type_high_naturalness + school_context_high_greenness + ses_child 
  NC ~ sex_male + landscape_type_high_naturalness + school_context_high_greenness + ses_child 
"
#evaluate model
sem_output <- sem(model = model_sem, data = sem_data)
sem_sum <- summary(sem_output, fit.measures = FALSE, standardized = TRUE)
sem_sum_std <- standardizedSolution(sem_output) %>%
  rename(est = `est.std`)
sem_fit <- fitmeasures(sem_output, c("chisq", "df", "pvalue", "cfi", "tli", "rmsea", "srmr",
                                "AIC", "BIC"))
interpret(sem_output)
cr_omega_sem <- compRelSEM(sem_output, tau.eq = F, obs.var = T)
cr_alpha_sem <- compRelSEM(sem_output, tau.eq = T, obs.var = T)
```

A multi-group SEM with a grouping by language (Dutch versus French) was also tested but yielded worse fit and reliability. We therefore will stick to a "simple" SEM for the whole data set. In total, `r sem_sum$data$nobs` observations with complete data were used in the SEM.

Tables \@ref(tab:sem-results) and \@ref(tab:sem-results-std) in the appendix show the full model results, both standardized and unstandardized. Figure \@ref(fig:sem-viz) shows the model results visually, including the standardized parameter estimates. Table \@ref(tab:sem-fit) shows that the fit of the model is overall satisfactory though there is room for improvement since the p-value of the Chi-square test is significant and the Tucker-Lewis Index (TLI) could be better as well.


```{r sem-fit}
avoid_scientif_notation <- function(x){as.character(signif(x, 3))}
 sem_fit %>%
  as.data.frame() %>%
  dplyr::mutate_if(is.numeric, avoid_scientif_notation) %>%
  kable(booktabs = TRUE,
        col.names = c(""),
        caption = "Fit measures for the SEM.") %>%
  kableExtra::kable_styling()
```



```{r sem-viz, fig.cap= "A graphical presentation of the SEM model, including standardized parameter estimates", warning = FALSE, message = FALSE, fig.width = 8}
nodelabels <- c(think_clearly = "th_cl", good_for_health = "gd_hlth",
                calm_down = "calm", learn_new_things = "lrn",
                feeling_free = "free", imagination = "img", explore = "exp",
                get_lost = "gt_l", unknown_persons = "unknwn",
                wild_animals = "wld_an", getting_hurt = "gt_hrt", beauty = "bty",
                respect = "rspc", happy = "hpp", spending_time = "sp_time",
                enjoy = "enj", part_of = "partof", sex_male = "male",
                landscape_type_high_naturalness = "hgh_natur",
                school_context_high_greenness = "hgh_green", ses_child = "SES",
                ATOP_benefits = "ATOP_b", ATOP_fears = "ATOP_f", NC = "NC")
semPaths(sem_output, "Standardized", "Standardized",
         style = "lisrel", layout = "tree", 
         residuals = FALSE, groups = "latents", pastel = 1, rotation = 2,
         fade = FALSE, optimizeLatRes = TRUE,
         fade = TRUE, edge.label.bg = TRUE, #edgeLabels = edgelabels
         nodeLabels = nodelabels)
#p$graphAttributes$Nodes$labels
```


The composite reliability ($\omega$) is `r round(unname(cr_omega_sem[1]), 3)` for ATOP_benefits, `r round(unname(cr_omega_sem[2]), 3)` for ATOP_fears and `r round(unname(cr_omega_sem[3]), 3)` for NC. So, in line with the earlier reliability results in the CFA, the reliability of ATOP_fears is not satisfactory. We already concluded in section  \@ref(conclusion-on-the-scale-questions) that this latent factor may not be valid or reliable and that the statements should be reviewed.

Looking at the SEM results, however, some interesting conclusions can be drawn. Firstly, the only statistically significant correlation between the three latent factors is a positive correlation between ATOP_benefits and NC (`r round(sem_sum_std %>% filter(lhs =="ATOP_benefits", rhs== "NC") %>% dplyr::pull(est), 2)`, p-value `r round(sem_sum_std %>% filter(lhs =="ATOP_benefits", rhs== "NC") %>% dplyr::pull(pvalue), 2)`).
This indicates that children with a higher nature connectedness also tend to have a positive ATOP_benefits score.
Secondly, we can assess each of the three regression models. The unstandardized  parameter estimates, standard deviations, and statistical significance are highlighted in Table \@ref(tab:sem-regression) (these can also be found in Table \@ref(tab:sem-results) in the appendix).
It can be seen that boys tend to have lower NC and ATOP_benefits but higher ATOP-fears.
A greener landscape around the school positively influences both NC and ATOP_benefits.
The school context does not have much influence although a greener playground may impact ATOP_benefits slightly negatively.
Finally, higher SES positively influences all of the latent factors.


```{r sem-regression, warning = FALSE, message = FALSE}
parameterEstimates(sem_output) %>%
  dplyr::filter(op == "~") %>%
  mutate(estimate = sprintf("%.3f (%.3f)%s",
                            est, se, gtools::stars.pval(pvalue))) %>%
  dplyr::select(lhs, rhs, estimate) %>%
  pivot_wider(names_from = lhs,
              values_from = estimate) %>%
  kable(booktabs = TRUE,
        caption = "Regression results from the SEM.",
        col.names = c("covariate", "ATOP_benefits", "ATOP_fears", "NC")) %>%
  kableExtra::kable_styling() %>%
  add_header_above(c("", "Dependent variable" = 3)) %>%
  kableExtra::add_footnote(label = "* p <.05, ** p <.01, *** p <.001")
```

```{r eval = FALSE}
sem_data <- sem_data %>%
  filter(community != "Dutch speaking.French speaking")
#---------------------evaluate a model grouped by language---------------------#
sem_output_grouped <- sem(model = model_sem, data = sem_data, group = "community")
summary(sem_output_grouped, standardized = TRUE)
fitmeasures(sem_output_grouped, c("chisq", "df", "pvalue", "cfi", "tli", "rmsea", "srmr",
                                "AIC", "BIC")) #chisquared is bad -> room for improvement
interpret(sem_output_grouped)#similar fit
compRelSEM(sem_output_grouped) # okay reliability of the latent factors

### -----------------------metric measurement invariance----------------------##
sem_output_grouped_metric <- sem(model = model_sem, data = sem_data,
                          group = "community",group.equal = c("loadings")
                          )
summary(sem_output_grouped_metric, standardized = TRUE)
fitmeasures(sem_output_grouped_metric, c("chisq", "df", "pvalue", "cfi", "tli", "rmsea", "srmr",
                                "AIC", "BIC")) #chisquared is bad -> room for improvement
interpret(sem_output_grouped_metric)#similar fit
compRelSEM(sem_output_grouped_metric) # okay reliability of the latent factors


### --------------------strong measurement invariance-------------------------##
sem_output_grouped_strong <- sem(model = model_sem, data = sem_data,
                          group = "community",group.equal = c("loadings", "intercepts")
                          )
summary(sem_output_grouped_strong, standardized = TRUE)
fitmeasures(sem_output_grouped_strong, c("chisq", "df", "pvalue", "cfi", "tli", "rmsea", "srmr",
                                "AIC", "BIC")) #chisquared is bad -> room for improvement
interpret(sem_output_grouped_strong)#similar fit
compRelSEM(sem_output_grouped_strong)

anov_atop_metric <- anova(sem_output_grouped, sem_output_grouped_metric) #metric model cannot be rejected
anov_atop_strong <- anova(sem_output_grouped, sem_output_grouped_strong)

```
